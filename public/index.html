<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Big Billion Days</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Big Billion Days Sale - Best Deals">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link rel="preconnect" href="https://flipback-production.up.railway.app">
<link rel="dns-prefetch" href="https://flipback-production.up.railway.app">
<link rel="preload" href="assets/images/topup.png" as="image">
<link rel="preload" href="assets/images/location.png" as="image">
<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:Arial,sans-serif;
}

body{
    background:#f1f3f6;
    overflow-x:hidden;
}

.top-space{
    height:20px;
    background:#fff;
}

.top-image img{
    width:100%;
    display:block;
    height:auto;
}

.location-bar{
    background:#fff;
    padding:12px;
    font-size:14px;
}

.search-wrapper{
    background:#fff;
    padding:10px 12px 14px;
}

.search-box{
    height:46px;
    border:2px solid #2f80ff;
    border-radius:14px;
    display:flex;
    align-items:center;
    padding:0 14px;
}

.search-box input{
    border:none;
    outline:none;
    width:100%;
    font-size:14px;
}

.countdown-wrapper {
    background: #2874f0;
    padding: 16px 12px;
    margin: 12px;
    border-radius: 12px;
    color: white;
    text-align: center;
}

.countdown-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 12px;
}

.countdown-timer {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
}

.time-box {
    background: rgba(255, 255, 255, 0.2);
    padding: 8px;
    border-radius: 8px;
    min-width: 55px;
}

.time-value {
    font-size: 24px;
    font-weight: 800;
}

.time-label {
    font-size: 11px;
    font-weight: 500;
    margin-top: 2px;
}

.time-separator {
    font-size: 20px;
    font-weight: 700;
}

.countdown-subtitle {
    font-size: 13px;
    font-weight: 600;
    margin-top: 10px;
}

@media (max-width: 480px) {
    .time-box {
        min-width: 60px;
        padding: 8px 6px;
    }
    
    .time-value {
        font-size: 24px;
    }
    
    .time-label {
        font-size: 11px;
    }
    
    .countdown-title {
        font-size: 16px;
    }
}

.promo-wrapper{
    background:#fff;
    padding:12px 0 20px;
}

.promo-slider{
    display:flex;
    overflow-x:auto;
    scroll-snap-type:x mandatory;
    scroll-behavior:smooth;
    -webkit-overflow-scrolling:touch;
}

.promo-slider::-webkit-scrollbar{
    display:none;
}

.promo-card{
    flex:0 0 100%;
    padding:0 12px;
    scroll-snap-align:center;
}

.promo-card img{
    width:100%;
    border-radius:16px;
    height:160px;
    object-fit:cover;
}

.promo-dots{
    display:flex;
    justify-content:center;
    gap:6px;
    margin-top:10px;
}

.dot{
    width:6px;
    height:6px;
    background:#cfcfcf;
    border-radius:50%;
}

.dot.active{
    width:16px;
    background:#000;
    border-radius:10px;
}

.product-section{
    background:#fff;
    border-radius:20px;
    padding:2px;
    margin-bottom: 20px;
}

.product-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:2px;
}

.product-card{
    background:#fff;
    border-radius:3px;
    padding:12px;
    overflow:hidden;
    cursor:pointer;
    border: 1px solid #e0e0e0;
    transition: transform 0.2s, box-shadow 0.2s;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.badge-container {
    margin-bottom: 8px;
}

.bestseller-badge {
    background: #ff9f00;
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 2px;
    display: inline-block;
    text-transform: uppercase;
    margin-bottom: 6px;
}

.trending-badge {
    background: #ff6b6b;
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 2px;
    display: inline-block;
    text-transform: uppercase;
    margin-bottom: 6px;
}

.product-img{
    display:flex;
    justify-content:center;
    align-items:center;
    height:140px;
    margin-bottom: 12px;
    background: #f8f8f8;
    border-radius: 8px;
}

.product-img img{
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    transition: opacity 0.3s;
}

.product-img img.loading {
    opacity: 0;
}

.product-img img.loaded {
    opacity: 1;
}

.product-name-container {
    margin-bottom: 8px;
}

.product-name {
    font-size: 14px;
    font-weight: 700;
    color: #212121;
    line-height: 1.3;
    height: 36px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.price-container {
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
}

.original-price {
    font-size: 12px;
    color: #878787;
    text-decoration: line-through;
}

.discounted-price {
    font-size: 18px;
    font-weight: 700;
    color: #212121;
}

.discount-percent {
    font-size: 12px;
    font-weight: 600;
    color: #388e3c;
    background: #f0f9ff;
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
}

.offer-container {
    background: #fff8e6;
    border-radius: 4px;
    padding: 6px 8px;
    margin-bottom: 8px;
}

.wow-text {
    font-size: 12px;
    font-weight: 700;
    color: #212121;
    display: inline;
    margin-right: 6px;
}

.offer-price {
    font-size: 12px;
    color: #212121;
    font-weight: 500;
    display: inline;
}

.rating-container {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
}

.stars {
    color: #388e3c;
    font-size: 14px;
    letter-spacing: -1px;
}

.rating-count {
    font-size: 11px;
    color: #878787;
}

.assured-badge {
    font-size: 10px;
    color: #388e3c;
    font-weight: 600;
    background: #f0f9ff;
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
    margin-left: 4px;
}

.location-bar {
    background: #fff;
    padding: 12px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    color: #212121;
    font-weight: 500;
}

.location-icon {
    width: 16px;
    height: 16px;
}

.location-text {
    color: #212121;
}

.select-location {
    color: #2874f0;
    text-decoration: none;
    font-weight: 400;
    cursor: pointer;
}

.select-location:hover {
    text-decoration: underline;
}

.loading-indicator {
    text-align: center;
    padding: 20px;
    color: #878787;
    grid-column: 1 / -1;
}

.load-more-btn {
    display: none;
}

.footer {
    background: #fff;
    padding: 20px;
    text-align: center;
    color: #878787;
    font-size: 14px;
    border-top: 1px solid #e0e0e0;
    margin-top: 20px;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.time-box {
    animation: pulse 2s infinite;
}

.no-products {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 20px;
    color: #666;
    font-size: 16px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.skeleton-card{
    background:#fff;
    border-radius:14px;
    padding:12px;
    overflow:hidden;
    border: 1px solid #e0e0e0;
}

.skeleton-img{
    height:140px;
    background:#f0f0f0;
    position:relative;
    overflow:hidden;
    margin-bottom: 12px;
    border-radius: 8px;
}

.skeleton-img::after{
    content:"";
    position:absolute;
    top:0;
    left:-100%;
    width:100%;
    height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.5),transparent);
    animation:skeleton-loading 1.5s infinite;
}

.skeleton-content{
    padding:0;
}

.skeleton-title{
    height:18px;
    width:80%;
    background:#f0f0f0;
    border-radius:4px;
    margin-bottom:10px;
    position:relative;
    overflow:hidden;
}

.skeleton-title::after{
    content:"";
    position:absolute;
    top:0;
    left:-100%;
    width:100%;
    height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.5),transparent);
    animation:skeleton-loading 1.5s infinite 0.2s;
}

.skeleton-price{
    height:22px;
    width:40%;
    background:#f0f0f0;
    border-radius:4px;
    position:relative;
    overflow:hidden;
}

.skeleton-price::after{
    content:"";
    position:absolute;
    top:0;
    left:-100%;
    width:100%;
    height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.5),transparent);
    animation:skeleton-loading 1.5s infinite 0.4s;
}

@keyframes skeleton-loading{
    0%{left:-100%;}
    100%{left:100%;}
}

.error-container {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 20px;
    background: #fff;
    border-radius: 12px;
    margin: 20px;
}

.error-icon {
    font-size: 48px;
    margin-bottom: 16px;
    color: #dc3545;
}

.error-message {
    color: #666;
    margin-bottom: 20px;
}

.error-details {
    color: #888;
    font-size: 12px;
    margin-top: 10px;
}

.load-more-status {
    display: none;
}

/* Flipkart Style Small Loading Progress Bar */
.flipkart-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 1px;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s;
}

.flipkart-loader.show {
    opacity: 1;
}

.flipkart-loader .progress {
    height: 100%;
    width: 0%;
    background: #ff9f00;
    position: relative;
    overflow: hidden;
}

.flipkart-loader .progress::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent 0%, 
        #2874f0 25%, 
        #ff9f00 50%, 
        #2874f0 75%, 
        transparent 100%);
    animation: flipkart-shimmer 1.5s infinite linear;
}

@keyframes flipkart-shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Minimal Loader */
.minimal-loader {
    display: inline-block;
    width: 16px;
    height: 16px;
}

.minimal-loader div {
    box-sizing: border-box;
    display: block;
    position: absolute;
    width: 12px;
    height: 12px;
    margin: 2px;
    border: 2px solid #2874f0;
    border-radius: 50%;
    animation: minimal-loader 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    border-color: #2874f0 transparent transparent transparent;
}

.minimal-loader div:nth-child(1) {
    animation-delay: -0.45s;
}

.minimal-loader div:nth-child(2) {
    animation-delay: -0.3s;
}

.minimal-loader div:nth-child(3) {
    animation-delay: -0.15s;
}

@keyframes minimal-loader {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

/* Skeleton Loading Enhancements */
.skeleton-pulse {
    animation: skeleton-pulse 1.5s ease-in-out infinite;
}

@keyframes skeleton-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.loading-status {
    grid-column: 1 / -1;
    text-align: center;
    padding: 30px 20px;
    color: #666;
    font-size: 14px;
}

.loading-status .minimal-loader {
    display: inline-block;
    margin-bottom: 10px;
}
</style>
</head>
<body>

<!-- Flipkart Style Small Loading Progress Bar -->
<div class="flipkart-loader" id="flipkartLoader">
    <div class="progress" id="progressBar"></div>
</div>

<div class="top-space"></div>
<div class="top-image">
    <img src="assets/images/topup.png" alt="Top Banner" loading="lazy">
</div>
<div class="location-bar">
    <span class="location-icon"><img src="assets/images/location.png" alt="Location" loading="lazy"></span>
    <span class="location-text">Location not set</span> 
    <a href="#" class="select-location">Select delivery location ></a>
</div>

<div class="search-wrapper">
    <div class="search-box">
        <input type="text" placeholder="Search for Products" id="searchInput">
    </div>
</div>

<div class="promo-wrapper">
    <div class="promo-slider" id="slider">
        <div class="promo-card"><img src="assets/images/banner1.webp" alt="Banner 1" loading="lazy"></div>
        <div class="promo-card"><img src="assets/images/banner2.webp" alt="Banner 2" loading="lazy"></div>
        <div class="promo-card"><img src="assets/images/banner3.webp" alt="Banner 3" loading="lazy"></div>
        <div class="promo-card"><img src="assets/images/banner4.webp" alt="Banner 4" loading="lazy"></div>
    </div>
    <div class="promo-dots">
        <span class="dot active"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
    </div>
</div>

<div class="countdown-wrapper">
    <div class="countdown-title"> Flipkart Big Billion Days - Sale Ending Soon!</div>
    <div class="countdown-timer">
        <div class="time-box">
            <div class="time-value" id="hours">00</div>
            <div class="time-label">Hours</div>
        </div>
        <div class="time-separator">:</div>
        <div class="time-box">
            <div class="time-value" id="minutes">14</div>
            <div class="time-label">Minutes</div>
        </div>
        <div class="time-separator">:</div>
        <div class="time-box">
            <div class="time-value" id="seconds">40</div>
            <div class="time-label">Seconds</div>
        </div>
    </div>
    <div class="countdown-subtitle">Hurry! Deals are selling out fast</div>
</div>

<div class="product-section">
    <div class="product-grid" id="productGrid">
        <!-- Skeleton loading will be shown initially -->
        <div class="skeleton-card skeleton-pulse">
            <div class="skeleton-img"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-price"></div>
            </div>
        </div>
        <div class="skeleton-card skeleton-pulse">
            <div class="skeleton-img"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-price"></div>
            </div>
        </div>
        <div class="skeleton-card skeleton-pulse">
            <div class="skeleton-img"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-price"></div>
            </div>
        </div>
        <div class="skeleton-card skeleton-pulse">
            <div class="skeleton-img"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-price"></div>
            </div>
        </div>
        <div class="skeleton-card skeleton-pulse">
            <div class="skeleton-img"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-price"></div>
            </div>
        </div>
        <div class="skeleton-card skeleton-pulse">
            <div class="skeleton-img"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-price"></div>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    <p>© 2024 Big Billion Days. All rights reserved.</p>
</div>

<script>
class LoaderManager {
    constructor() {
        this.flipkartLoader = document.getElementById('flipkartLoader');
        this.progressBar = document.getElementById('progressBar');
        this.progressInterval = null;
    }
    
    show() {
        this.flipkartLoader.classList.add('show');
        this.progressBar.style.width = '30%';
        
        if (this.progressInterval) {
            clearInterval(this.progressInterval);
        }
        
        this.progressInterval = setInterval(() => {
            const currentWidth = parseFloat(this.progressBar.style.width) || 30;
            const newWidth = Math.min(currentWidth + 10, 90);
            this.progressBar.style.width = newWidth + '%';
        }, 500);
    }
    
    complete() {
        if (this.progressInterval) {
            clearInterval(this.progressInterval);
        }
        
        this.progressBar.style.width = '100%';
        
        setTimeout(() => {
            this.flipkartLoader.classList.remove('show');
            this.progressBar.style.width = '0%';
        }, 300);
    }
    
    hide() {
        this.flipkartLoader.classList.remove('show');
        this.progressBar.style.width = '0%';
        
        if (this.progressInterval) {
            clearInterval(this.progressInterval);
            this.progressInterval = null;
        }
    }
}

class ProductManager {
    constructor() {
        this.API_URL = "/api/products";
        this.productGrid = document.getElementById("productGrid");
        this.loaderManager = new LoaderManager();
        
        this.allProducts = [];
        this.isLoading = false;
        
        this.cacheKey = 'flipkart_products_cache';
        this.cacheExpiry = 5 * 60 * 1000;
        
        this.initialize();
    }
    
    initialize() {
        this.allProducts = [];
        this.isLoading = false;
    }
    
    formatPrice(price) {
        if (price === undefined || price === null || price === '' || isNaN(price)) {
            return "₹0";
        }
        
        const num = parseFloat(price);
        if (isNaN(num)) return "₹0";
        
        return '₹' + num.toLocaleString('en-IN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }
    
    calculateDiscountPercent(originalPrice, discountedPrice) {
        if (!originalPrice || !discountedPrice || originalPrice <= 0 || discountedPrice <= 0) return 0;
        
        const original = parseFloat(originalPrice);
        const discounted = parseFloat(discountedPrice);
        
        if (isNaN(original) || isNaN(discounted) || original <= discounted) return 0;
        
        const discount = ((original - discounted) / original) * 100;
        return Math.round(discount);
    }
    
    getCachedProducts() {
        try {
            const cached = localStorage.getItem(this.cacheKey);
            if (!cached) return null;
            
            const { data, timestamp } = JSON.parse(cached);
            const now = Date.now();
            
            if (now - timestamp < this.cacheExpiry) {
                console.log('Loading from cache');
                return data;
            }
        } catch (error) {
            console.log('Cache error:', error);
        }
        return null;
    }
    
    cacheProducts(products) {
        try {
            const cacheData = {
                data: products,
                timestamp: Date.now()
            };
            localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
        } catch (error) {
            console.log('Failed to cache products:', error);
        }
    }
    
    async loadAllProducts() {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.loaderManager.show();
        
        // Show loading status
        this.productGrid.innerHTML = `
            <div class="loading-status">
                <div class="minimal-loader">
                    <div></div><div></div><div></div><div></div>
                </div>
                <p>Loading products...</p>
            </div>
        `;
        
        const cachedProducts = this.getCachedProducts();
        if (cachedProducts) {
            this.allProducts = cachedProducts;
            this.displayAllProducts();
            this.loaderManager.complete();
            
            // Fetch fresh data in background
            this.fetchFreshProducts();
            return;
        }
        
        await this.fetchProducts();
    }
    
    async fetchProducts() {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch(this.API_URL, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                signal: controller.signal
            }).catch(() => {
                throw new Error('Network request failed');
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data && data.data && Array.isArray(data.data) && data.data.length > 0) {
                this.allProducts = data.data.map((item, index) => ({
                    id: item.id || `product-${index}`,
                    ...item
                }));
                
                this.cacheProducts(this.allProducts);
                this.displayAllProducts();
                
            } else if (data && Array.isArray(data) && data.length > 0) {
                this.allProducts = data.map((item, index) => ({
                    id: item.id || `product-${index}`,
                    ...item
                }));
                
                this.cacheProducts(this.allProducts);
                this.displayAllProducts();
                
            } else {
                this.showNoProducts();
            }
            
        } catch (error) {
            console.error('Error loading products:', error);
            
            const cachedProducts = this.getCachedProducts();
            if (cachedProducts && cachedProducts.length > 0) {
                this.allProducts = cachedProducts;
                this.displayAllProducts();
            } else {
                this.showError(error);
            }
            
        } finally {
            this.loaderManager.complete();
            this.isLoading = false;
        }
    }
    
    async fetchFreshProducts() {
        try {
            const response = await fetch(this.API_URL, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data && data.data && Array.isArray(data.data) && data.data.length > 0) {
                    this.allProducts = data.data.map((item, index) => ({
                        id: item.id || `product-${index}`,
                        ...item
                    }));
                    
                    this.cacheProducts(this.allProducts);
                }
            }
        } catch (error) {
            console.log('Background fetch failed:', error);
        }
    }
    
    displayAllProducts() {
        if (this.allProducts.length === 0) {
            this.showNoProducts();
            return;
        }
        
        const fragment = document.createDocumentFragment();
        
        this.allProducts.forEach((product, index) => {
            if (!product) return;
            
            const cardHtml = this.createProductCard(product, index);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHtml;
            const cardElement = tempDiv.firstElementChild;
            
            const imgElement = cardElement.querySelector('img');
            if (imgElement) {
                imgElement.classList.add('loading');
                this.lazyLoadImage(imgElement);
            }
            
            cardElement.addEventListener("click", () => {
                if (product.id) {
                    window.location.href = `view.html?id=${product.id}`;
                }
            });
            
            fragment.appendChild(cardElement);
        });
        
        this.productGrid.innerHTML = '';
        this.productGrid.appendChild(fragment);
    }
    
    lazyLoadImage(imgElement) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.getAttribute('data-src') || img.src;
                    
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        img.src = src;
                        img.classList.remove('loading');
                        img.classList.add('loaded');
                    };
                    tempImg.onerror = () => {
                        img.src = 'https://via.placeholder.com/400x400?text=Product+Image';
                        img.classList.remove('loading');
                        img.classList.add('loaded');
                    };
                    tempImg.src = src;
                    
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: '50px' });
        
        observer.observe(imgElement);
    }
    
    createProductCard(p, index) {
        const originalPrice = p.price || 0;
        const discountAmount = p.discount_amount || 0;
        const discountPercent = p.discount_percent || 0;
        const discountedPrice = p.discounted_price || 0;
        
        let sellingPrice = discountedPrice;
        
        if (!sellingPrice && originalPrice && discountAmount) {
            sellingPrice = parseFloat(originalPrice) - parseFloat(discountAmount);
        } else if (!sellingPrice && originalPrice && discountPercent) {
            sellingPrice = parseFloat(originalPrice) * (1 - parseFloat(discountPercent)/100);
        } else if (!sellingPrice || sellingPrice === 0) {
            sellingPrice = parseFloat(originalPrice);
        }
        
        if (isNaN(sellingPrice)) sellingPrice = 0;
        
        let finalDiscountPercent = discountPercent;
        if (!finalDiscountPercent && originalPrice > 0 && sellingPrice > 0) {
            finalDiscountPercent = this.calculateDiscountPercent(originalPrice, sellingPrice);
        }
        
        const formattedOriginalPrice = this.formatPrice(originalPrice);
        const formattedSellingPrice = this.formatPrice(sellingPrice);
        
        const bankOfferPrice = sellingPrice > 0 ? sellingPrice * 0.95 : 0;
        const formattedBankOfferPrice = this.formatPrice(Math.round(bankOfferPrice));
        
        let imageSrc = "";
        if (p.image) {
            imageSrc = p.image;
        } else if (p.main_image) {
            imageSrc = p.main_image;
        } else {
            imageSrc = 'https://via.placeholder.com/400x400?text=Product+Image';
        }
        
        const productName = p.name || "Product Name";
        const isBestseller = index % 3 === 0;
        const isTrending = index % 5 === 0;
        const rating = (Math.random() * 2 + 3).toFixed(1);
        const ratingCount = Math.floor(Math.random() * 1000) + 100;
        
        let displayDiscountPercent = finalDiscountPercent;
        if (finalDiscountPercent > 0) {
            displayDiscountPercent = finalDiscountPercent;
        }
        
        return `
            <div class="product-card" data-id="${p.id}">
                ${isBestseller ? '<div class="bestseller-badge">Bestseller</div>' : ''}
                ${isTrending ? '<div class="trending-badge">Trending</div>' : ''}
                
                <div class="product-img">
                    <img data-src="${imageSrc}" alt="${productName}" 
                         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Crect width='400' height='400' fill='%23f8f8f8'/%3E%3C/svg%3E"
                         class="loading">
                </div>
                
                <div class="product-name-container">
                    <div class="product-name">${productName}</div>
                </div>
                
                <div class="price-container">
                    ${originalPrice > sellingPrice && sellingPrice > 0 ? 
                        `<span class="original-price">${formattedOriginalPrice}</span>` : 
                        ''
                    }
                    <span class="discounted-price">${formattedSellingPrice}</span>
                    ${finalDiscountPercent > 0 ? 
                        `<span class="discount-percent">↓${displayDiscountPercent}%</span>` : 
                        ''
                    }
                </div>
                
                <div class="offer-container">
                    <span class="wow-text">WOW!</span>
                    <span class="offer-price">${formattedBankOfferPrice} with Bank offer</span>
                </div>
                
                <div class="rating-container">
                    <span class="stars">${'★'.repeat(Math.floor(rating))}${rating % 1 >= 0.5 ? '★' : ''}</span>
                    <span class="rating-count">${ratingCount}</span>
                    <span class="assured-badge">Assured</span>
                </div>
            </div>
        `;
    }
    
    showNoProducts() {
        this.productGrid.innerHTML = `
            <div class="no-products">
                <p>No products available at the moment.</p>
                <p style="font-size: 14px; margin-top: 10px; color: #888;">Check back soon for new deals!</p>
            </div>
        `;
    }
    
    showError(error) {
        this.productGrid.innerHTML = `
            <div class="error-container">
                <div class="error-icon">⚠️</div>
                <div class="error-message">Failed to load products.</div>
                <p style="color: #666; margin-bottom: 20px;">Please check your internet connection.</p>
                <button id="retryLoadButton" class="retry-button" style="
                    background: #2874f0;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                ">Retry Loading</button>
                <div class="error-details" style="margin-top: 15px;">
                    Error: ${error.message || 'Network error'}
                </div>
            </div>
        `;
        
        document.getElementById('retryLoadButton')?.addEventListener('click', () => {
            this.loadAllProducts();
        });
    }
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    const productManager = new ProductManager();
    
    // Countdown Timer
    function updateCountdownTimer() {
        const hoursElement = document.getElementById('hours');
        const minutesElement = document.getElementById('minutes');
        const secondsElement = document.getElementById('seconds');
        
        let hours = parseInt(hoursElement.textContent) || 0;
        let minutes = parseInt(minutesElement.textContent) || 14;
        let seconds = parseInt(secondsElement.textContent) || 40;
        
        seconds--;
        
        if (seconds < 0) {
            seconds = 59;
            minutes--;
            
            if (minutes < 0) {
                minutes = 59;
                hours--;
                
                if (hours < 0) {
                    hours = 0;
                    minutes = 0;
                    seconds = 0;
                    
                    document.querySelector('.countdown-title').textContent = 'Flash Sale Ended!';
                    document.querySelector('.countdown-subtitle').textContent = 'Check back soon for more deals';
                    document.querySelector('.countdown-timer').style.display = 'none';
                    document.querySelector('.countdown-wrapper').style.background = 'linear-gradient(135deg, #666, #888)';
                    
                    clearInterval(timerInterval);
                    return;
                }
            }
        }
        
        hoursElement.textContent = hours.toString().padStart(2, '0');
        minutesElement.textContent = minutes.toString().padStart(2, '0');
        secondsElement.textContent = seconds.toString().padStart(2, '0');
    }
    const timerInterval = setInterval(updateCountdownTimer, 1000);
    
    // Promo Slider
    const slider = document.getElementById("slider");
    const dots = document.querySelectorAll(".dot");
    const slides = document.querySelectorAll(".promo-card");
    let index = 0;
    const totalSlides = slides.length;
    
    function updateSlider() {
        const slideWidth = slider.clientWidth;
        slider.scrollTo({ left: index * slideWidth, behavior: "smooth" });
        dots.forEach(dot => dot.classList.remove("active"));
        if(dots[index]) dots[index].classList.add("active");
    }
    
    setInterval(() => { 
        index++; 
        if(index >= totalSlides) index = 0; 
        updateSlider(); 
    }, 3000);
    
    slider.addEventListener("scroll", () => {
        const slideWidth = slider.clientWidth;
        index = Math.round(slider.scrollLeft / slideWidth);
        dots.forEach(dot => dot.classList.remove("active"));
        if(dots[index]) dots[index].classList.add("active");
    });
    
    // Location selection
    document.querySelector('.select-location').addEventListener('click', function(event) {
        event.preventDefault();
        window.location.href = 'address.html';
    });
    
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    
    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(() => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (!searchTerm) {
                productManager.displayAllProducts();
                return;
            }
            
            const filteredProducts = productManager.allProducts.filter(product => 
                product.name && product.name.toLowerCase().includes(searchTerm)
            );
            
            productManager.productGrid.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productManager.productGrid.innerHTML = `
                    <div class="no-products">
                        No products found for "${searchTerm}". Try a different search term.
                    </div>
                `;
            } else {
                const fragment = document.createDocumentFragment();
                
                filteredProducts.forEach((product, index) => {
                    const cardHtml = productManager.createProductCard(product, index);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = cardHtml;
                    const cardElement = tempDiv.firstElementChild;
                    
                    const imgElement = cardElement.querySelector('img');
                    if (imgElement) {
                        imgElement.classList.add('loading');
                        productManager.lazyLoadImage(imgElement);
                    }
                    
                    cardElement.addEventListener("click", () => {
                        if (product.id) {
                            window.location.href = `view.html?id=${product.id}`;
                        }
                    });
                    
                    fragment.appendChild(cardElement);
                });
                
                productManager.productGrid.appendChild(fragment);
            }
        }, 500);
    });
    
    // Load all products at once
    productManager.loadAllProducts();
    
    // Refresh products when tab becomes visible
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            const cacheTime = localStorage.getItem('flipkart_products_cache_timestamp');
            if (cacheTime && Date.now() - parseInt(cacheTime) > 600000) {
                productManager.fetchFreshProducts();
            }
        }
    });
    
    console.log('Application initialized successfully');
});
</script>
</body>
</html>