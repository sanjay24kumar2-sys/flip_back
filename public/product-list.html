<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äì Product Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
body{background:#f0f2f5;font-size:14px}
.header{background:#2874f0;color:#fff;padding:15px}
.header-content{display:flex;flex-direction:column;gap:10px}
.header-title{font-size:20px;font-weight:600;text-align:center}
.header-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.btn{background:#fff;color:#2874f0;text-decoration:none;padding:8px 15px;border-radius:5px;font-weight:600;border:none;cursor:pointer;font-size:14px}
.btn-add{background:#2e7d32;color:#fff}
.btn-upi{background:#7b1fa2;color:#fff}
.btn:hover{opacity:0.9;transform:translateY(-1px)}

.container{margin:15px;padding:0}
.search-box{margin-bottom:15px}
.search-input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;background:#fff}
.search-input:focus{outline:none;border-color:#2874f0;box-shadow:0 0 0 2px rgba(40,116,240,0.2)}

.stats{display:flex;gap:12px;margin-bottom:20px;justify-content:center}
.stat-card{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center;flex:1;max-width:200px}
.stat-value{font-size:22px;font-weight:bold;color:#2874f0;margin-bottom:5px}
.stat-label{color:#666;font-size:12px}

.products-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
.product-card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.1);transition:transform 0.3s}
.product-card:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.product-image{width:100%;height:150px;object-fit:cover;border-bottom:1px solid #eee}
.product-content{padding:12px}
.product-name{font-weight:600;font-size:14px;color:#333;margin-bottom:8px;line-height:1.3;height:36px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.product-price{color:#2e7d32;font-weight:bold;font-size:16px;margin-bottom:5px}
.product-discount{color:#f44336;font-size:12px;margin-bottom:10px}
.product-actions{display:flex;gap:6px;margin-top:12px}
.action-btn{padding:6px 10px;border:none;border-radius:4px;font-size:11px;cursor:pointer;font-weight:500;flex:1;text-align:center}
.edit-btn{background:#e8f5e9;color:#2e7d32}
.delete-btn{background:#ffebee;color:#d32f2f}

.empty-state{text-align:center;padding:40px 15px;color:#666;background:#fff;border-radius:8px;grid-column:span 2}
.empty-title{font-size:18px;margin-bottom:8px;color:#333}
.empty-text{font-size:14px;color:#999;margin-bottom:20px}

.loading{text-align:center;padding:40px 15px;color:#666;grid-column:span 2}
.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #2874f0;border-radius:50%;width:40px;height:40px;margin:0 auto 15px;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;padding:20px 15px}
.modal-content{background:#fff;padding:20px;border-radius:10px;max-width:400px;width:100%;margin:0 auto;animation:slideUp 0.3s ease}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-size:18px;margin-bottom:15px;color:#333;font-weight:600}
.modal-actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}
.btn-cancel{background:#f5f5f5;color:#666;padding:10px 20px}
.btn-confirm{background:#f44336;color:#fff;padding:10px 20px}
.btn-save{background:#4caf50;color:#fff;padding:10px 20px}

.form-group{margin-bottom:15px}
.form-label{display:block;margin-bottom:5px;font-size:14px;font-weight:600;color:#333}
.form-input{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px}
.form-input:focus{border-color:#2874f0;outline:none;box-shadow:0 0 0 2px rgba(40,116,240,0.2)}

.upi-display{padding:15px;background:#f8f5ff;border-radius:8px;margin-bottom:20px;border:1px solid #e1bee7}
.upi-current{font-weight:600;color:#7b1fa2;font-size:16px;word-break:break-all;margin-top:5px}
.upi-label{color:#666;font-size:13px}
.upi-actions{margin-top:15px;display:flex;gap:8px}

.alert{position:fixed;top:20px;right:15px;padding:12px 20px;border-radius:8px;font-size:14px;z-index:10000;max-width:300px;box-shadow:0 3px 10px rgba(0,0,0,0.2);animation:slideIn 0.3s ease}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.alert-success{background:#4caf50;color:white}
.alert-error{background:#f44336;color:white}

@media(max-width:480px){
    .header{padding:12px}
    .header-title{font-size:18px}
    .btn{padding:8px 12px;font-size:13px}
    .stats{gap:8px}
    .stat-card{padding:12px}
    .stat-value{font-size:18px}
    .products-grid{grid-template-columns:1fr;gap:10px}
    .product-image{height:130px}
    .action-btn{padding:5px 8px;font-size:11px}
    .modal-content{padding:15px;max-width:95%}
}
</style>
</head>

<body>
<div class="header">
    <div class="header-content">
        <div class="header-title">üì¶ Product Dashboard</div>
        <div class="header-actions">
            <a href="/add-product.html" class="btn btn-add">‚ûï Add Product</a>
            <button class="btn btn-upi" onclick="openUPIModal()">üí≥ UPI ID</button>
            <button class="btn" onclick="refreshList()">üîÑ Refresh</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="üîç Search products..." onkeyup="filterProducts()">
    </div>

    <div class="stats" id="stats">
        <div class="stat-card">
            <div class="stat-value" id="totalProducts">0</div>
            <div class="stat-label">Total Products</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalSales">‚Çπ0</div>
            <div class="stat-label">Total Value</div>
        </div>
    </div>

    <div class="products-grid" id="productsGrid">
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading products...</div>
        </div>
    </div>
</div>

<!-- Delete Product Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-title">üóëÔ∏è Delete Product</div>
        <p id="deleteMessage" style="color:#666;font-size:14px;line-height:1.5">Are you sure you want to delete this product?</p>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn btn-confirm" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<!-- UPI ID Management Modal -->
<div class="modal" id="upiModal">
    <div class="modal-content">
        <div class="modal-title">üí≥ Manage UPI ID</div>
        
        <div class="upi-display" id="currentUPIDisplay">
            <div class="upi-label">Current UPI ID:</div>
            <div class="upi-current" id="currentUPIText">No UPI ID set</div>
            <div class="upi-actions">
                <button class="action-btn upi-btn" onclick="copyUPI()" style="background:#7b1fa2;color:white">Copy UPI</button>
                <button class="action-btn delete-btn" onclick="showDeleteUPIModal()">Remove</button>
            </div>
        </div>
        
        <div id="upiForm">
            <div class="form-group">
                <label class="form-label">New UPI ID</label>
                <input type="text" id="upiIdInput" class="form-input" 
                       placeholder="username@upi"
                       required>
                <div style="font-size:12px;color:#666;margin-top:5px">Example: username@okhdfcbank</div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeUPIModal()">Cancel</button>
            <button class="btn btn-save" onclick="saveUPI()">Save UPI ID</button>
        </div>
    </div>
</div>

<!-- Delete UPI Modal -->
<div class="modal" id="deleteUPIModal">
    <div class="modal-content">
        <div class="modal-title">‚ùå Remove UPI ID</div>
        <p id="deleteUPIMessage" style="color:#666;font-size:14px;line-height:1.5">Are you sure you want to remove the current UPI ID?</p>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeDeleteUPIModal()">Cancel</button>
            <button class="btn btn-confirm" onclick="confirmDeleteUPI()">Remove</button>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = 'http://localhost:3000/api';
let allProducts = [];
let productToDelete = null;
let currentUPI = null;

function formatPrice(price) {
    return '‚Çπ' + price.toLocaleString('en-IN');
}

function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 15px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#ff9800'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => {
            if (alertDiv.parentNode) {
                document.body.removeChild(alertDiv);
            }
        }, 300);
    }, 3000);
}

async function loadProducts() {
    const productsGrid = document.getElementById('productsGrid');
    productsGrid.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading products...</div>
        </div>
    `;

    try {
        const response = await fetch(`${API_BASE_URL}/products`);
        if (!response.ok) throw new Error('Network error');
        
        const result = await response.json();

        if (result.success && result.data) {
            allProducts = result.data;
        } else if (Array.isArray(result)) {
            allProducts = result;
        } else if (typeof result === 'object') {
            allProducts = Object.values(result);
        } else {
            allProducts = [];
        }

        await loadUPI();

        if (allProducts.length === 0) {
            productsGrid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-title">No products found</div>
                    <div class="empty-text">Add your first product to get started</div>
                    <a href="/add-product.html" class="btn btn-add" style="margin-top:15px;display:inline-block">Add First Product</a>
                </div>
            `;
        } else {
            renderProducts(allProducts);
            updateStats(allProducts);
        }

    } catch (error) {
        console.error('Error:', error);
        productsGrid.innerHTML = `
            <div class="empty-state">
                <div class="empty-title">Error loading products</div>
                <div class="empty-text">Please check your connection</div>
                <button class="btn" onclick="loadProducts()" style="margin-top:15px">Try Again</button>
            </div>
        `;
    }
}

async function loadUPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/upi`);
        if (response.ok) {
            const data = await response.json();
            currentUPI = data.upi_id || null;
            updateUPIDisplay();
        } else {
            currentUPI = null;
            updateUPIDisplay();
        }
    } catch (error) {
        console.error('Error loading UPI:', error);
        currentUPI = null;
        updateUPIDisplay();
    }
}

function updateUPIDisplay() {
    const upiDisplay = document.getElementById('currentUPIText');
    
    if (currentUPI) {
        upiDisplay.textContent = currentUPI;
    } else {
        upiDisplay.textContent = 'No UPI ID set';
    }
}

function renderProducts(products) {
    const productsGrid = document.getElementById('productsGrid');

    if (products.length === 0) {
        productsGrid.innerHTML = `
            <div class="empty-state">
                <div class="empty-title">No products found</div>
                <div class="empty-text">Try changing your search</div>
            </div>
        `;
        return;
    }

    let html = '';
    products.forEach(product => {
        const productId = product.id || product._id || 'N/A';
        const name = product.name || 'Unnamed';
        const price = Number(product.price) || 0;
        const discount = Number(product.discount_amount) || 0;
        const mainImage = product.main_image || product.mainImage || '';
        const discountedPrice = price - discount;
        const displayName = name.length > 50 ? name.substring(0, 50) + '...' : name;
        const displayId = productId.length > 8 ? productId.substring(0, 8) + '...' : productId;

        html += `
            <div class="product-card">
                <img src="${mainImage}" class="product-image" alt="${name}" 
                     onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGNEY4Ii8+CjxwYXRoIGQ9Ik0xNTAgNzBDMTcwLjU1OSA3MCAxODcgNTMuNTU5MSAxODcgMzNDMTg3IDEyLjQ0MDkgMTcwLjU1OSAtNCAxNTAgLTNDMTI5LjQ0MSAtNCAxMTMgMTIuNDQwOSAxMTMgMzNDMTEzIDUzLjU1OTEgMTI5LjQ0MSA3MCAxNTAgNzBaIiBmaWxsPSIjODg4Ii8+CjxwYXRoIGQ9Ik0yMjAgMTYwSDE4MEMxNzcuNzkxIDE2MCAxNzYgMTU4LjIwOSAxNzYgMTU2VjEyMC44ODdDMTc2IDExOS4wMjQgMTc2Ljc5IDExNy4yNTEgMTc4LjIzOCAxMTUuOTYzTDE4NS4yMzggMTA4LjA4OEMxODYuNTU0IDEwNi45MTIgMTg4LjAwOCAxMDYgMTg5LjU1MiAxMDZIMTkwLjQ0OEMxOTEuOTkyIDEwNiAxOTMuNDQ2IDEwNi45MTIgMTk0Ljc2MiAxMDguMDg4TDIwMS43NjIgMTE1Ljk2M0MyMDMuMjEgMTE3LjI1MSAyMDQgMTE5LjAyNCAyMDQgMTIwLjg4N1YxNTZDMjA0IDE1OC4yMDkgMjAyLjIwOSAxNjAgMjAwIDE2MFoiIGZpbGw9IiM4ODgiLz4KPC9zdmc+'">
                <div class="product-content">
                    <div class="product-name">${displayName}</div>
                    <div class="product-price">${formatPrice(discountedPrice)}</div>
                    ${discount > 0 ? `<div class="product-discount">Save ‚Çπ${discount}</div>` : ''}
                    <div style="font-size:10px;color:#888;margin-bottom:8px">ID: ${displayId}</div>
                    <div class="product-actions">
                        <button class="action-btn delete-btn" onclick="showDeleteModal('${productId}', '${name.replace(/'/g, "\\'")}')">Delete</button>
                    </div>
                </div>
            </div>
        `;
    });

    productsGrid.innerHTML = html;
}

function updateStats(products) {
    const totalProducts = products.length;
    const totalValue = products.reduce((sum, p) => {
        const price = Number(p.price) || 0;
        const discount = Number(p.discount_amount) || 0;
        return sum + (price - discount);
    }, 0);

    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('totalSales').textContent = formatPrice(totalValue);
}

function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    let filtered = allProducts;

    if (searchTerm) {
        filtered = filtered.filter(p => 
            (p.name || '').toLowerCase().includes(searchTerm) ||
            (p.id || p._id || '').toString().toLowerCase().includes(searchTerm)
        );
    }

    renderProducts(filtered);
    updateStats(filtered);
}

function showDeleteModal(productId, productName) {
    productToDelete = productId;
    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${productName}"?`;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
    productToDelete = null;
}

async function confirmDelete() {
    if (!productToDelete) return;

    try {
        const product = allProducts.find(p => 
            p.id === productToDelete || 
            p._id === productToDelete
        );

        if (!product) {
            showAlert('Product not found', 'error');
            closeModal();
            return;
        }

        const actualId = product.id || product._id;
        const response = await fetch(`${API_BASE_URL}/products/${actualId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            allProducts = allProducts.filter(p => 
                (p.id || p._id) !== actualId
            );
            filterProducts();
            closeModal();
            showAlert('‚úÖ Product deleted successfully', 'success');
        } else {
            throw new Error('Delete failed');
        }

    } catch (error) {
        console.error('Delete error:', error);
        showAlert('‚ùå Error deleting product', 'error');
        closeModal();
    }
}

// UPI Management Functions
function openUPIModal() {
    document.getElementById('upiIdInput').value = currentUPI || '';
    document.getElementById('upiModal').style.display = 'block';
}

function closeUPIModal() {
    document.getElementById('upiModal').style.display = 'none';
}

function showDeleteUPIModal() {
    if (!currentUPI) {
        showAlert('No UPI ID to remove', 'error');
        return;
    }
    document.getElementById('deleteUPIMessage').textContent = `Are you sure you want to remove UPI ID: ${currentUPI}?`;
    document.getElementById('deleteUPIModal').style.display = 'block';
}

function closeDeleteUPIModal() {
    document.getElementById('deleteUPIModal').style.display = 'none';
}

async function saveUPI() {
    const upiId = document.getElementById('upiIdInput').value.trim();

    if (!upiId) {
        showAlert('Please enter a UPI ID', 'error');
        return;
    }

    const upiRegex = /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/;
    if (!upiRegex.test(upiId)) {
        showAlert('Please enter a valid UPI ID (e.g., username@upi)', 'error');
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/upi`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ upi_id: upiId })
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
            currentUPI = upiId;
            updateUPIDisplay();
            closeUPIModal();
            showAlert('‚úÖ UPI ID saved successfully!', 'success');
        } else {
            throw new Error(result.error || 'Failed to save UPI');
        }
    } catch (error) {
        console.error('Error saving UPI:', error);
        showAlert('‚ùå Error saving UPI ID', 'error');
    }
}

async function confirmDeleteUPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/upi`, {
            method: 'DELETE'
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
            currentUPI = null;
            updateUPIDisplay();
            closeDeleteUPIModal();
            closeUPIModal();
            showAlert('‚úÖ UPI ID removed successfully', 'success');
        } else {
            throw new Error('Failed to delete UPI');
        }
    } catch (error) {
        console.error('Error deleting UPI:', error);
        showAlert('‚ùå Error removing UPI ID', 'error');
    }
}

function copyUPI() {
    if (!currentUPI) {
        showAlert('No UPI ID to copy', 'error');
        return;
    }

    navigator.clipboard.writeText(currentUPI)
        .then(() => {
            showAlert('üìã UPI ID copied to clipboard!', 'success');
        })
        .catch(err => {
            console.error('Copy failed:', err);
            showAlert('‚ùå Failed to copy UPI ID', 'error');
        });
}

function refreshList() {
    loadProducts();
    showAlert('üîÑ Refreshing product list...', 'success');
}

// Modal close handlers
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('upiModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeUPIModal();
    }
});

document.getElementById('deleteUPIModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteUPIModal();
    }
});

// Escape key to close modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
        closeUPIModal();
        closeDeleteUPIModal();
    }
});

// Initialize on load
window.addEventListener('load', function() {
    loadProducts();
});

// Auto-refresh every 30 seconds
setInterval(() => {
    if (document.visibilityState === 'visible') {
        loadProducts();
    }
}, 30000);
</script>
</body>
</html>