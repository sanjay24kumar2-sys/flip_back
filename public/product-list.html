<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Product Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
body{background:#f0f2f5;font-size:14px}
.header{background:#2874f0;color:#fff;padding:12px 15px}
.header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.header-title{font-size:18px;font-weight:600}
.header-actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{background:#fff;color:#2874f0;text-decoration:none;padding:6px 12px;border-radius:3px;font-weight:600;border:none;cursor:pointer;font-size:13px;white-space:nowrap}
.btn-add{background:#2e7d32;color:#fff}
.btn-add:hover{background:#1b5e20}
.btn-upi{background:#7b1fa2;color:#fff}
.btn-upi:hover{background:#4a0072}

.container{max-width:1200px;margin:15px auto;padding:0 10px}
.search-box{margin-bottom:15px}
.search-input{width:100%;padding:10px;border:1px solid #ddd;border-radius:3px;font-size:13px}

.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px}
.stat-card{background:#fff;padding:12px;border-radius:3px;box-shadow:0 1px 3px rgba(0,0,0,0.1);text-align:center}
.stat-value{font-size:20px;font-weight:bold;color:#2874f0;margin-bottom:5px}
.stat-label{color:#666;font-size:11px}

.filters{display:flex;gap:8px;margin-bottom:15px;overflow-x:auto;padding-bottom:5px}
.filters::-webkit-scrollbar{height:3px}
.filters::-webkit-scrollbar-track{background:#f1f1f1}
.filters::-webkit-scrollbar-thumb{background:#888;border-radius:3px}
.filter-btn{padding:6px 10px;background:#fff;border:1px solid #ddd;border-radius:3px;cursor:pointer;font-size:12px;white-space:nowrap}
.filter-btn.active{background:#2874f0;color:#fff;border-color:#2874f0}

.products-table{width:100%;background:#fff;border-radius:3px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:600px}
th{background:#f5f5f5;padding:10px 8px;text-align:left;font-weight:600;font-size:12px;border-bottom:1px solid #ddd}
td{padding:10px 8px;border-bottom:1px solid #eee;font-size:12px}
tr:hover{background:#f9f9f9}
.product-image{width:50px;height:50px;object-fit:cover;border-radius:3px}
.actions{display:flex;gap:4px;flex-wrap:wrap}
.action-btn{padding:3px 6px;border:none;border-radius:2px;font-size:11px;cursor:pointer;white-space:nowrap}
.edit-btn{background:#e3f2fd;color:#1565c0}
.delete-btn{background:#ffebee;color:#c62828}
.upi-btn{background:#e1bee7;color:#4a148c}
.status-active{color:#2e7d32;font-weight:600}
.status-inactive{color:#f44336;font-weight:600}
.stock-low{color:#f44336;font-weight:600}
.price{color:#2e7d32;font-weight:600;font-size:13px}

.empty-state{text-align:center;padding:30px 15px;color:#666;background:#fff;border-radius:3px}
.empty-title{font-size:16px;margin-bottom:8px}
.empty-text{font-size:13px;color:#999}

.loading{text-align:center;padding:30px;color:#666}
.loading-spinner{border:2px solid #f3f3f3;border-top:2px solid #2874f0;border-radius:50%;width:30px;height:30px;margin:0 auto 10px;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;padding:20px 10px}
.modal-content{background:#fff;padding:15px;border-radius:3px;max-width:400px;width:100%;margin:0 auto}
.modal-title{font-size:16px;margin-bottom:12px;color:#333}
.modal-actions{display:flex;gap:8px;margin-top:15px;justify-content:flex-end}
.btn-cancel{background:#f5f5f5;color:#666}
.btn-confirm{background:#f44336;color:#fff}
.btn-save{background:#4caf50;color:#fff}

.form-group{margin-bottom:15px}
.form-label{display:block;margin-bottom:5px;font-size:13px;font-weight:600}
.form-input{width:100%;padding:10px;border:1px solid #ddd;border-radius:3px;font-size:13px}

.upi-display{padding:12px;background:#f8f5ff;border-radius:5px;margin-bottom:15px;border:1px solid #e1bee7}
.upi-current{font-weight:600;color:#7b1fa2;font-size:15px;word-break:break-all}
.upi-label{color:#666;font-size:12px;margin-bottom:5px}
.upi-actions{margin-top:10px;display:flex;gap:5px}

.alert{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:3px;font-size:14px;z-index:10000;max-width:300px;box-shadow:0 3px 10px rgba(0,0,0,0.2);animation:slideIn 0.3s ease}
.alert-success{background:#4caf50;color:white}
.alert-error{background:#f44336;color:white}
.alert-warning{background:#ff9800;color:white}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

@media(max-width:1024px){
    .stats{grid-template-columns:repeat(2,1fr)}
}

@media(max-width:768px){
    .header-content{flex-direction:column;text-align:center}
    .header-actions{justify-content:center;width:100%}
    .stats{grid-template-columns:repeat(2,1fr)}
    .stat-card:last-child{grid-column:span 2}
    table{font-size:11px}
    th,td{padding:6px 4px}
    .product-image{width:40px;height:40px}
    .modal-content{max-width:95%}
}

@media(max-width:480px){
    .stats{grid-template-columns:1fr}
    .stat-card:last-child{grid-column:span 1}
    .header-title{font-size:16px}
    .btn{font-size:12px;padding:5px 10px}
    .filter-btn{font-size:11px;padding:5px 8px}
    .modal-content{padding:12px}
}
</style>
</head>

<body>
<div class="header">
    <div class="header-content">
        <div class="header-title">Product Dashboard</div>
        <div class="header-actions">
            <a href="/add-product.html" class="btn btn-add">Add New Product</a>
            <button class="btn btn-upi" onclick="openUPIModal()">Manage UPI ID</button>
            <button class="btn" onclick="refreshList()">Refresh</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="Search products..." onkeyup="filterProducts()">
    </div>

    <div class="stats" id="stats">
        <div class="stat-card">
            <div class="stat-value" id="totalProducts">0</div>
            <div class="stat-label">Total Products</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalStock">0</div>
            <div class="stat-label">Total Stock</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="activeProducts">0</div>
            <div class="stat-label">Active Products</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="currentUPI">Not Set</div>
            <div class="stat-label">Current UPI ID</div>
        </div>
    </div>

    <div class="filters">
        <button class="filter-btn active" onclick="setFilter('all')">All</button>
        <button class="filter-btn" onclick="setFilter('electronics')">Electronics</button>
        <button class="filter-btn" onclick="setFilter('fashion')">Fashion</button>
        <button class="filter-btn" onclick="setFilter('home')">Home</button>
        <button class="filter-btn" onclick="setFilter('beauty')">Beauty</button>
        <button class="filter-btn" onclick="setFilter('sports')">Sports</button>
        <button class="filter-btn" onclick="setFilter('lowStock')">Low Stock</button>
    </div>

    <div class="products-table" id="productsTable">
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading products...</div>
        </div>
    </div>
</div>

<!-- Delete Product Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-title">Delete Product</div>
        <p id="deleteMessage">Are you sure you want to delete this product?</p>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn btn-confirm" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-title">Edit Product</div>
        <div id="editForm">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="editName" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select id="editCategory" class="form-input">
                    <option value="">Select Category</option>
                    <option value="electronics">Electronics</option>
                    <option value="fashion">Fashion</option>
                    <option value="home">Home</option>
                    <option value="beauty">Beauty</option>
                    <option value="sports">Sports</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="editDescription" class="form-input" style="height:60px;resize:vertical"></textarea>
            </div>
            <div class="form-group" style="display:flex;gap:10px">
                <div style="flex:1">
                    <label class="form-label">Price</label>
                    <input type="number" id="editPrice" class="form-input">
                </div>
                <div style="flex:1">
                    <label class="form-label">Discount %</label>
                    <input type="number" id="editDiscount" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Stock</label>
                <input type="number" id="editStock" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="editStatus" class="form-input">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
            <button class="btn btn-confirm" onclick="saveEdit()">Save</button>
        </div>
    </div>
</div>

<!-- UPI ID Management Modal -->
<div class="modal" id="upiModal">
    <div class="modal-content">
        <div class="modal-title">Manage UPI ID</div>
        
        <div class="upi-display" id="currentUPIDisplay">
            <div class="upi-label">Current UPI ID:</div>
            <div class="upi-current" id="currentUPIText">No UPI ID set</div>
            <div class="upi-actions">
                <button class="action-btn upi-btn" onclick="copyUPI()">Copy UPI</button>
                <button class="action-btn delete-btn" onclick="showDeleteUPIModal()">Remove</button>
            </div>
        </div>
        
        <div id="upiForm">
            <div class="form-group">
                <label class="form-label">New UPI ID</label>
                <input type="text" id="upiIdInput" class="form-input" 
                       placeholder="username@upi"
                       required>
                <div style="font-size:11px;color:#666;margin-top:3px">Enter UPI ID like username@okhdfcbank</div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeUPIModal()">Cancel</button>
            <button class="btn btn-save" onclick="saveUPI()">Save UPI ID</button>
        </div>
    </div>
</div>

<!-- Delete UPI Modal -->
<div class="modal" id="deleteUPIModal">
    <div class="modal-content">
        <div class="modal-title">Remove UPI ID</div>
        <p id="deleteUPIMessage">Are you sure you want to remove the current UPI ID?</p>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeDeleteUPIModal()">Cancel</button>
            <button class="btn btn-confirm" onclick="confirmDeleteUPI()">Remove</button>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = 'http://localhost:3000/api';
let allProducts = [];
let currentFilter = 'all';
let productToDelete = null;
let productToEdit = null;
let currentUPI = null;

function formatPrice(price) {
    return '₹' + price.toLocaleString('en-IN');
}

function calculateFinalPrice(price, discount) {
    return price - (price * discount / 100);
}

function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#ff9800'};
        color: white;
        padding: 12px 20px;
        border-radius: 3px;
        font-size: 14px;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => {
            if (alertDiv.parentNode) {
                document.body.removeChild(alertDiv);
            }
        }, 300);
    }, 3000);
}

async function loadProducts() {
    const productsTable = document.getElementById('productsTable');
    productsTable.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading products...</div>
        </div>
    `;

    try {
        // Load products
        const response = await fetch(`${API_BASE_URL}/products`);
        if (!response.ok) throw new Error('Network error');
        
        const result = await response.json();

        if (result.success && result.data) {
            allProducts = result.data;
        } else if (Array.isArray(result)) {
            allProducts = result;
        } else if (typeof result === 'object') {
            allProducts = Object.values(result);
        } else {
            allProducts = [];
        }

        // Load UPI ID
        await loadUPI();

        if (allProducts.length === 0) {
            productsTable.innerHTML = `
                <div class="empty-state">
                    <div class="empty-title">No products found</div>
                    <div class="empty-text">Add your first product to get started</div>
                </div>
            `;
        } else {
            renderProducts(allProducts);
            updateStats(allProducts);
        }

    } catch (error) {
        console.error('Error:', error);
        productsTable.innerHTML = `
            <div class="empty-state">
                <div class="empty-title">Error loading products</div>
                <div class="empty-text">Please check your connection and try again</div>
                <button class="btn" onclick="loadProducts()" style="margin-top:10px">Try Again</button>
            </div>
        `;
    }
}

async function loadUPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/upi`);
        if (response.ok) {
            const data = await response.json();
            currentUPI = data.upi_id || null;
            updateUPIDisplay();
        } else {
            currentUPI = null;
            updateUPIDisplay();
        }
    } catch (error) {
        console.error('Error loading UPI:', error);
        currentUPI = null;
        updateUPIDisplay();
    }
}

function updateUPIDisplay() {
    const upiDisplay = document.getElementById('currentUPIText');
    const upiStat = document.getElementById('currentUPI');
    
    if (currentUPI) {
        upiDisplay.textContent = currentUPI;
        upiStat.textContent = currentUPI.length > 15 ? 
            currentUPI.substring(0, 15) + '...' : currentUPI;
    } else {
        upiDisplay.textContent = 'No UPI ID set';
        upiStat.textContent = 'Not Set';
    }
}

function renderProducts(products) {
    const productsTable = document.getElementById('productsTable');

    if (products.length === 0) {
        productsTable.innerHTML = `
            <div class="empty-state">
                <div class="empty-title">No products found</div>
                <div class="empty-text">Try changing your search or filter</div>
            </div>
        `;
        return;
    }

    let html = `
        <table>
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

    products.forEach(product => {
        const productId = product.id || product._id || 'N/A';
        const name = product.name || 'Unnamed';
        const category = product.category || 'uncategorized';
        const price = Number(product.price) || 0;
        const discount = Number(product.discount) || 0;
        const stock = Number(product.stock) || 0;
        const mainImage = product.main_image || product.mainImage || '';
        const status = product.status || 'active';
        const finalPrice = calculateFinalPrice(price, discount);
        const displayName = name.length > 20 ? name.substring(0, 20) + '...' : name;

        html += `
            <tr>
                <td><img src="${mainImage}" class="product-image" alt="${name}" onerror="this.style.display='none';this.parentNode.innerHTML='<div style=\\'width:50px;height:50px;background:#f5f5f5;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#999;font-size:10px\\'>No image</div>'"></td>
                <td>
                    <div style="font-weight:600;font-size:13px">${displayName}</div>
                    <div style="font-size:11px;color:#666;word-break:break-all">ID: ${productId.substring(0, 15)}${productId.length > 15 ? '...' : ''}</div>
                </td>
                <td>${category}</td>
                <td>
                    <div class="price">${formatPrice(finalPrice)}</div>
                    ${discount > 0 ? `<div style="font-size:11px;color:#999">${discount}% off</div>` : ''}
                </td>
                <td class="${stock < 10 ? 'stock-low' : ''}">${stock}</td>
                <td class="${status === 'active' ? 'status-active' : 'status-inactive'}">${status}</td>
                <td>
                    <div class="actions">
                        <button class="action-btn edit-btn" onclick="openEditModal('${productId}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="showDeleteModal('${productId}', '${name.replace(/'/g, "\\'")}')">Delete</button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    productsTable.innerHTML = html;
}

function updateStats(products) {
    const totalProducts = products.length;
    const totalStock = products.reduce((sum, p) => sum + (Number(p.stock) || 0), 0);
    const activeProducts = products.filter(p => (p.status || 'active') === 'active').length;

    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('totalStock').textContent = totalStock;
    document.getElementById('activeProducts').textContent = activeProducts;
}

function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    filterProducts();
}

function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    let filtered = allProducts;

    if (currentFilter !== 'all') {
        if (currentFilter === 'lowStock') {
            filtered = filtered.filter(p => (Number(p.stock) || 0) < 10);
        } else {
            filtered = filtered.filter(p => (p.category || '').toLowerCase() === currentFilter);
        }
    }

    if (searchTerm) {
        filtered = filtered.filter(p => 
            (p.name || '').toLowerCase().includes(searchTerm) ||
            (p.category || '').toLowerCase().includes(searchTerm) ||
            (p.id || p._id || '').toString().toLowerCase().includes(searchTerm)
        );
    }

    renderProducts(filtered);
    updateStats(filtered);
}

function showDeleteModal(productId, productName) {
    productToDelete = productId;
    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${productName}"?`;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
    productToDelete = null;
}

async function confirmDelete() {
    if (!productToDelete) return;

    try {
        const product = allProducts.find(p => 
            p.id === productToDelete || 
            p._id === productToDelete
        );

        if (!product) {
            showAlert('Product not found', 'error');
            closeModal();
            return;
        }

        const actualId = product.id || product._id;
        const response = await fetch(`${API_BASE_URL}/products/${actualId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            allProducts = allProducts.filter(p => 
                (p.id || p._id) !== actualId
            );
            filterProducts();
            closeModal();
            showAlert('Product deleted successfully', 'success');
        } else {
            throw new Error('Delete failed');
        }

    } catch (error) {
        console.error('Delete error:', error);
        showAlert('Error deleting product', 'error');
        closeModal();
    }
}

function openEditModal(productId) {
    productToEdit = productId;
    const product = allProducts.find(p => 
        p.id === productId || 
        p._id === productId
    );

    if (!product) {
        showAlert('Product not found', 'error');
        return;
    }

    document.getElementById('editName').value = product.name || '';
    document.getElementById('editCategory').value = product.category || '';
    document.getElementById('editDescription').value = product.description || '';
    document.getElementById('editPrice').value = product.price || 0;
    document.getElementById('editDiscount').value = product.discount || 0;
    document.getElementById('editStock').value = product.stock || 0;
    document.getElementById('editStatus').value = product.status || 'active';

    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    productToEdit = null;
}

async function saveEdit() {
    if (!productToEdit) return;

    const product = allProducts.find(p => 
        p.id === productToEdit || 
        p._id === productToEdit
    );

    if (!product) {
        showAlert('Product not found', 'error');
        closeEditModal();
        return;
    }

    const updatedProduct = {
        ...product,
        name: document.getElementById('editName').value.trim(),
        category: document.getElementById('editCategory').value,
        description: document.getElementById('editDescription').value.trim(),
        price: Number(document.getElementById('editPrice').value),
        discount: Number(document.getElementById('editDiscount').value),
        stock: Number(document.getElementById('editStock').value),
        status: document.getElementById('editStatus').value,
        updated_at: new Date().toISOString()
    };

    if (!updatedProduct.name) {
        showAlert('Product name is required', 'error');
        return;
    }

    if (updatedProduct.price <= 0) {
        showAlert('Price must be greater than 0', 'error');
        return;
    }

    try {
        const actualId = product.id || product._id;
        const response = await fetch(`${API_BASE_URL}/products/${actualId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedProduct)
        });

        if (response.ok) {
            const index = allProducts.findIndex(p => 
                (p.id || p._id) === actualId
            );
            if (index !== -1) {
                allProducts[index] = updatedProduct;
                renderProducts(allProducts);
                updateStats(allProducts);
            }
            closeEditModal();
            showAlert('Product updated successfully', 'success');
        } else {
            throw new Error('Update failed');
        }

    } catch (error) {
        console.error('Update error:', error);
        showAlert('Error updating product', 'error');
    }
}

// UPI Management Functions
function openUPIModal() {
    document.getElementById('upiIdInput').value = currentUPI || '';
    document.getElementById('upiModal').style.display = 'block';
}

function closeUPIModal() {
    document.getElementById('upiModal').style.display = 'none';
}

function showDeleteUPIModal() {
    if (!currentUPI) {
        showAlert('No UPI ID to remove', 'error');
        return;
    }
    document.getElementById('deleteUPIMessage').textContent = `Are you sure you want to remove UPI ID: ${currentUPI}?`;
    document.getElementById('deleteUPIModal').style.display = 'block';
}

function closeDeleteUPIModal() {
    document.getElementById('deleteUPIModal').style.display = 'none';
}

async function saveUPI() {
    const upiId = document.getElementById('upiIdInput').value.trim();

    if (!upiId) {
        showAlert('Please enter a UPI ID', 'error');
        return;
    }

    // Basic UPI validation
    const upiRegex = /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/;
    if (!upiRegex.test(upiId)) {
        showAlert('Please enter a valid UPI ID (e.g., username@upi)', 'error');
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/upi`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ upi_id: upiId })
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
            currentUPI = upiId;
            updateUPIDisplay();
            closeUPIModal();
            showAlert('UPI ID saved successfully!', 'success');
        } else {
            throw new Error(result.error || 'Failed to save UPI');
        }
    } catch (error) {
        console.error('Error saving UPI:', error);
        showAlert('Error saving UPI ID', 'error');
    }
}

async function confirmDeleteUPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/upi`, {
            method: 'DELETE'
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
            currentUPI = null;
            updateUPIDisplay();
            closeDeleteUPIModal();
            closeUPIModal();
            showAlert('UPI ID removed successfully', 'success');
        } else {
            throw new Error('Failed to delete UPI');
        }
    } catch (error) {
        console.error('Error deleting UPI:', error);
        showAlert('Error removing UPI ID', 'error');
    }
}

function copyUPI() {
    if (!currentUPI) {
        showAlert('No UPI ID to copy', 'error');
        return;
    }

    navigator.clipboard.writeText(currentUPI)
        .then(() => {
            showAlert('UPI ID copied to clipboard!', 'success');
        })
        .catch(err => {
            console.error('Copy failed:', err);
            showAlert('Failed to copy UPI ID', 'error');
        });
}

function refreshList() {
    loadProducts();
}

// Modal close handlers
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});

document.getElementById('upiModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeUPIModal();
    }
});

document.getElementById('deleteUPIModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteUPIModal();
    }
});

// Escape key to close modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
        closeEditModal();
        closeUPIModal();
        closeDeleteUPIModal();
    }
});

// Initialize on load
window.addEventListener('load', function() {
    loadProducts();
});

// Handle window resize
window.addEventListener('resize', function() {
    renderProducts(allProducts.filter(p => {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        let matches = true;
        
        if (currentFilter !== 'all') {
            if (currentFilter === 'lowStock') {
                matches = (Number(p.stock) || 0) < 10;
            } else {
                matches = (p.category || '').toLowerCase() === currentFilter;
            }
        }
        
        if (searchTerm && matches) {
            matches = (p.name || '').toLowerCase().includes(searchTerm) ||
                     (p.category || '').toLowerCase().includes(searchTerm) ||
                     (p.id || p._id || '').toString().toLowerCase().includes(searchTerm);
        }
        
        return matches;
    }));
});
</script>
</body>
</html>
