<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Payments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{ box-sizing:border-box; font-family:Arial,sans-serif }
body{ margin:0; background:#f1f3f6 }

.header{ position:fixed; top:0; left:0; width:100%; background:#fff; z-index:1000;
  box-shadow:0 2px 4px rgba(0,0,0,.12)}
.header-top{ padding:12px 16px; display:flex; gap:12px; border-bottom:1px solid #eee }
.back-arrow{ width:10px; height:10px; border-left:2px solid #000;
  border-bottom:2px solid #000; transform:rotate(45deg); cursor:pointer }
.header-space{ height:70px }

.card{ background:#fff; border-radius:8px; margin:8px; padding:12px;
  box-shadow:0 1px 3px rgba(0,0,0,.08)}

.product-row{ display:flex; gap:12px; align-items:center }
.product-img{ width:70px; height:70px; border:1px solid #eee;
  border-radius:6px; object-fit:contain }
.product-info{ flex:1 }
.product-name{ font-size:14px; font-weight:bold; margin-bottom:6px }
.product-price{ color:#000 }

.pay-option{ display:flex; align-items:center; gap:12px;
  padding:12px; border:2px solid #2874f0; border-radius:8px;
  background:#f0f7ff }

.pay-option img{ width:28px }

.price-row{ display:flex; justify-content:space-between; margin:6px 0 }

/* ðŸ”¥ FIXED BOTTOM BAR */
.bottom-bar{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;      /* ðŸ‘ˆ CENTER FIX */
  box-shadow:0 -1px 3px rgba(0,0,0,.15)
}

.bottom-amount{
  font-size:18px;
  font-weight:bold;
  line-height:1;           /* ðŸ‘ˆ TEXT ALIGN FIX */
}

.btn{
  background:#fb641b;
  color:#fff;
  border:none;
  padding:12px 22px;
  font-size:16px;
  border-radius:4px
}
.btn:disabled{ background:#ccc }
.btn.processing{ background:#999 }

.off-img{
  width:100%;
  border-radius:6px;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div class="header">
  <div class="header-top">
    <div class="back-arrow" onclick="history.back()"></div>
    <strong>Payments</strong>
  </div>
</div>
<div class="header-space"></div>

<div class="card" id="productCard">Loading product...</div>

<div class="card">
  <img src="assets/images/off.png" class="off-img">
  <h4>Select Payment Method</h4>
  <div class="pay-option">
    <img src="assets/images/phonepe-logo.webp"> PhonePe
  </div>
</div>

<div class="card">
  <h4>Price Details (Reference Only)</h4>
  <div class="price-row"><span>Price</span><span id="price">â‚¹--</span></div>
  <div class="price-row"><span>Delivery</span><span style="color:green">FREE</span></div>
  <hr>
  <div class="price-row"><b>Total</b><b id="total">â‚¹--</b></div>
</div>

<div style="height:90px"></div>

<div class="bottom-bar">
  <div class="bottom-amount" id="bottomAmount">â‚¹--</div>
  <button class="btn" id="payButton" disabled>Pay with PhonePe</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

const PRODUCTS_API = "/api/products";
const UPI_API = "/api/upi";
  const payButton = document.getElementById("payButton");
  let productPrice = 0;
  let upiId = "";

  const qs = k => new URLSearchParams(location.search).get(k);

  function isMobileDevice(){
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  function generateTransactionId(){
    return 'TXN' + Date.now().toString().slice(-8) + Math.floor(Math.random()*1000);
  }

  function createPhonePeUrl(){
    const data = {
      contact:{ vpa: upiId, type:"VPA" },
      p2pPaymentCheckoutParams:{
        note: generateTransactionId(),
        transactionContext:"p2p",
        initialAmount: String(productPrice * 100),
        currency:"INR",
        checkoutType:"DEFAULT"
      }
    };
    return `phonepe://native?data=${btoa(JSON.stringify(data))}&id=p2ppayment`;
  }

  payButton.onclick = () => {
    if(!isMobileDevice()){
      payButton.textContent = "Use Mobile Device";
      setTimeout(()=>payButton.textContent="Pay with PhonePe",1500);
      return;
    }
    payButton.disabled = true;
    payButton.classList.add("processing");
    payButton.textContent = "Opening PhonePe...";
    window.location.href = createPhonePeUrl();
    setTimeout(()=>{
      payButton.disabled = false;
      payButton.classList.remove("processing");
      payButton.textContent = "Pay with PhonePe";
    },1500);
  };

  fetch(UPI_API).then(r=>r.json()).then(d=>{
    upiId = d?.data?.upi_id || d?.upi_id || "";
  });

  fetch(PRODUCTS_API).then(r=>r.json()).then(d=>{
    const p = d.data.find(x => String(x.id)===qs("id") || String(x._id)===qs("id"));
    productPrice = Number(p.discounted_price || p.price || 0);
    productCard.innerHTML = `
      <div class="product-row">
        <img src="${p.main_image || p.image}" class="product-img">
        <div class="product-info">
          <div class="product-name">${p.name || p.title}</div>
          <div class="product-price">â‚¹${productPrice}</div>
        </div>
      </div>`;
    price.innerText =
    total.innerText =
    bottomAmount.innerText = "â‚¹" + productPrice;
    payButton.disabled = false;
  });

});
</script>
</body>
</html>