<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äì Add Product</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{min-height:100vh;background:#f1f3f6;display:flex;flex-direction:column;align-items:center}
.header{width:100%;background:#2874f0;color:#fff;padding:18px;font-size:22px;font-weight:bold;text-align:center}
.card{width:100%;max-width:500px;background:#fff;margin:30px 16px;padding:26px;border-radius:18px;box-shadow:0 8px 22px rgba(0,0,0,.15)}
h2{margin-bottom:20px;color:#333;text-align:center}
.group{margin-bottom:15px}
label{font-size:13px;font-weight:600;color:#555;display:block;margin-bottom:6px}
input,select{width:100%;padding:13px;border-radius:12px;border:1px solid #ccc;font-size:14px}
.price-row{display:flex;gap:12px;margin-bottom:8px}
.price-row .group{flex:1;margin-bottom:0}
.discount-container{border:1px solid #e0e0e0;border-radius:12px;padding:15px;margin-top:10px;background:#f9f9f9}
.discount-title{font-size:14px;font-weight:bold;color:#2874f0;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.discount-info{font-size:12px;color:#666;margin-top:8px;font-style:italic}
.images-container{margin-top:20px;border-top:1px solid #eee;padding-top:20px}
.images-title{font-size:16px;font-weight:bold;color:#2874f0;margin-bottom:15px;text-align:center}
.images-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.image-slot{position:relative;height:120px;border:2px dashed #ddd;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8f9fa;cursor:pointer}
.image-slot.main{border-color:#2874f0;background:#e8f0fe}
.image-slot.main .slot-label{color:#2874f0}
.image-slot.filled{border-style:solid;border-color:#4caf50}
.slot-label{font-size:12px;font-weight:bold;color:#666;margin-top:5px}
.image-slot img{width:100%;height:100%;object-fit:cover;border-radius:8px}
.remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,0,0,0.8);color:white;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;display:none}
.image-slot:hover .remove-btn{display:block}
.buttons-container{display:flex;gap:10px;margin-top:25px}
.btn-save{flex:2;padding:15px;background:#2874f0;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:14px;cursor:pointer}
.btn-view{flex:1;padding:15px;background:#34a853;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:14px;cursor:pointer}
.success-message{background:#4caf50;color:white;padding:12px;border-radius:10px;margin-top:15px;display:none;text-align:center;font-size:14px}
.error-message{background:#f44336;color:white;padding:12px;border-radius:10px;margin-top:15px;display:none;text-align:center;font-size:14px}
</style>
</head>

<body>
<div class="header">Admin Dashboard</div>

<div class="card">
<h2>Add New Product</h2>

<div id="successMessage" class="success-message">
  ‚úÖ Product added successfully!
</div>

<div id="errorMessage" class="error-message">
  ‚ùå Error saving product!
</div>

<div class="group">
<label>Product Name *</label>
<input id="name" placeholder="Enter product name" required>
</div>

<!-- Price Section -->
<div class="group">
<label>Price Details</label>
<div class="price-row">
  <div class="group">
    <label>Price (‚Çπ) *</label>
    <input id="price" type="number" placeholder="Enter price" min="0" required>
  </div>
  <div class="group">
    <label>Discount (‚Çπ)</label>
    <input id="discount" type="number" placeholder="Discount amount" min="0" value="0">
  </div>
</div>
</div>

<!-- Discount Information Section -->
<div class="discount-container">
<div class="discount-title">üìä Discount Information</div>
<div class="price-row">
  <div class="group">
    <label>% Price Off</label>
    <input id="percentOff" type="number" placeholder="0" min="0" max="100" readonly>
  </div>
  <div class="group">
    <label>Discounted Price (‚Çπ)</label>
    <input id="discountedPrice" type="number" placeholder="0" readonly>
  </div>
</div>
<div class="discount-info">
  Note: This section is for reference only. Actual price and discount in ‚Çπ will be saved to database.
</div>
</div>

<div class="images-container">
<div class="images-title">Upload All 5 Images (1 Main + 4 Extra)</div>
<div class="images-grid" id="imagesGrid">
  <!-- Main Image Slot -->
  <div class="image-slot main" onclick="triggerMainImage()">
    <div style="font-size:24px;color:#2874f0"></div>
    <div class="slot-label">Main</div>
    <input type="file" id="mainImage" accept="image/*" style="display:none">
  </div>
  
  <!-- Extra Image Slots -->
  <div class="image-slot" onclick="triggerExtraImage(0)">
    <div style="font-size:24px;color:#666"></div>
    <div class="slot-label">Extra 1</div>
  </div>
  <div class="image-slot" onclick="triggerExtraImage(1)">
    <div style="font-size:24px;color:#666"></div>
    <div class="slot-label">Extra 2</div>
  </div>
  <div class="image-slot" onclick="triggerExtraImage(2)">
    <div style="font-size:24px;color:#666"></div>
    <div class="slot-label">Extra 3</div>
  </div>
  <div class="image-slot" onclick="triggerExtraImage(3)">
    <div style="font-size:24px;color:#666"></div>
    <div class="slot-label">Extra 4</div>
  </div>
</div>
<div class="status" id="uploadStatus"></div>
</div>

<div class="buttons-container">
<button class="btn-save" onclick="addProduct()"> Save Product</button>
<button class="btn-view" onclick="viewProducts()"> View Products</button>
</div>
</div>

<script>

function getAPIBaseURL() {
    if (window.ENV && window.ENV.API_URL) {
        return window.ENV.API_URL;
    }
    
    const currentHost = window.location.hostname;
    
    if (currentHost === 'localhost' || currentHost === '127.0.0.1' || currentHost === '') {
        // .env se PORT 3000 hai
        return 'http://localhost:3000/api';
    }
    
    // Production - tumhara actual domain
    const currentOrigin = window.location.origin;
    return `${currentOrigin}/api`;
}

const API_BASE_URL = getAPIBaseURL();
console.log("üü¢ Using API URL:", API_BASE_URL);
console.log("üåç Current Environment:", window.location.hostname);

// Price calculation for reference only
const priceInput = document.getElementById("price");
const discountInput = document.getElementById("discount");
const percentOffInput = document.getElementById("percentOff");
const discountedPriceInput = document.getElementById("discountedPrice");
const successMessage = document.getElementById("successMessage");
const errorMessage = document.getElementById("errorMessage");

// Update discount information (for reference only)
function updateDiscountInfo() {
    const price = Number(priceInput.value || 0);
    const discount = Number(discountInput.value || 0);
    
    const percentOff = price > 0 ? (discount / price * 100) : 0;
    const discountedPrice = price - discount;
    
    percentOffInput.value = percentOff.toFixed(2);
    discountedPriceInput.value = discountedPrice.toFixed(2);
}

// Add event listeners
priceInput.oninput = discountInput.oninput = updateDiscountInfo;

// Store all images
const allImages = {
    main: null,
    extra: [null, null, null, null]
};

// Main image upload
function triggerMainImage() {
    document.getElementById('mainImage').click();
}

document.getElementById('mainImage').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
        const mainSlot = document.querySelector('.image-slot.main');
        mainSlot.innerHTML = `
        <img src="${event.target.result}" alt="Main product image">
        <button class="remove-btn" onclick="removeMainImage(event)">√ó</button>
        `;
        mainSlot.classList.add('filled');
        
        allImages.main = file;
        updateUploadStatus();
    };
    reader.readAsDataURL(file);
};

// Extra images upload
function triggerExtraImage(index) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const extraSlots = document.querySelectorAll('.image-slot:not(.main)');
            extraSlots[index].innerHTML = `
            <img src="${event.target.result}" alt="Extra product image ${index + 1}">
            <button class="remove-btn" onclick="removeExtraImage(event, ${index})">√ó</button>
            `;
            extraSlots[index].classList.add('filled');
            
            allImages.extra[index] = file;
            updateUploadStatus();
        };
        reader.readAsDataURL(file);
    };
    
    input.click();
}

function removeMainImage(event) {
    event.stopPropagation();
    const mainSlot = document.querySelector('.image-slot.main');
    mainSlot.innerHTML = `
    <div style="font-size:24px;color:#2874f0"></div>
    <div class="slot-label">Main Image</div>
    <input type="file" id="mainImage" accept="image/*" style="display:none">
    `;
    mainSlot.classList.remove('filled');
    
    allImages.main = null;
    document.getElementById('mainImage').value = '';
    updateUploadStatus();
}

function removeExtraImage(event, index) {
    event.stopPropagation();
    const extraSlots = document.querySelectorAll('.image-slot:not(.main)');
    extraSlots[index].innerHTML = `
    <div style="font-size:24px;color:#666"></div>
    <div class="slot-label">Extra ${index + 1}</div>
    `;
    extraSlots[index].classList.remove('filled');
    
    allImages.extra[index] = null;
    updateUploadStatus();
}

// Update upload status
function updateUploadStatus() {
    const mainUploaded = allImages.main !== null;
    const extraUploaded = allImages.extra.filter(img => img !== null).length;
    const totalUploaded = (mainUploaded ? 1 : 0) + extraUploaded;
    
    const status = document.getElementById('uploadStatus');
    status.innerHTML = `üìÅ Uploaded: ${totalUploaded}/5 images`;
    
    if (totalUploaded === 5) {
        status.innerHTML = "‚úÖ All 5 images uploaded successfully!";
        status.style.color = "#2e7d32";
    } else if (totalUploaded > 0) {
        status.style.color = "#ff9800";
    } else {
        status.innerHTML = "";
    }
}

function showMessage(element, message) {
    element.innerHTML = message;
    element.style.display = 'block';
    element.scrollIntoView({ behavior: 'smooth' });
    
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}

function generateProductId() {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 6);
    return `PROD-${timestamp.toUpperCase()}-${random.toUpperCase()}`;
}

// Helper function to convert to base64
function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Check if backend server is running
async function checkBackendStatus() {
    try {
        console.log("üîç Checking backend server at:", API_BASE_URL);
        const response = await fetch(`${API_BASE_URL}/products`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const isOnline = response.ok;
        console.log(`üü¢ Backend server is: ${isOnline ? 'ONLINE' : 'OFFLINE'}`);
        return isOnline;
    } catch (error) {
        console.log('üî¥ Backend server is OFFLINE');
        console.log('Error:', error.message);
        return false;
    }
}

// Main function to add product
async function addProduct() {
    // Hide messages
    successMessage.style.display = 'none';
    errorMessage.style.display = 'none';
    
    // Validate form
    const name = document.getElementById('name').value.trim();
    const price = document.getElementById('price').value;
    const discount = document.getElementById('discount').value || 0;
    
    if (!name) {
        alert("Please enter product name");
        document.getElementById('name').focus();
        return;
    }
    
    if (!price || Number(price) <= 0) {
        alert("Please enter valid price");
        document.getElementById('price').focus();
        return;
    }
    
    // Check if discount is valid
    if (Number(discount) > Number(price)) {
        alert("Discount cannot be greater than price");
        document.getElementById('discount').focus();
        return;
    }
    
    // Check if all 5 images are uploaded
    if (!allImages.main) {
        alert("Please upload main image");
        triggerMainImage();
        return;
    }
    
    const uploadedExtras = allImages.extra.filter(img => img !== null).length;
    if (uploadedExtras < 4) {
        alert(`Please upload all 4 extra images. Currently uploaded: ${uploadedExtras}/4`);
        return;
    }

    // Show loading
    const saveBtn = document.querySelector('.btn-save');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = "Saving...";
    saveBtn.disabled = true;

    try {
        // Convert images to base64
        const mainImageBase64 = await toBase64(allImages.main);
        const extraImagesBase64 = await Promise.all(
            allImages.extra.map(img => img ? toBase64(img) : '')
        );

        const productId = generateProductId();
        
        const productData = {
            id: productId,
            name: name,
            description: name,
            price: Number(price),
            discount_amount: Number(discount),
            discount_percent: Number(percentOffInput.value) || 0,
            discounted_price: Number(discountedPriceInput.value) || 0,
            status: "active",
            main_image: mainImageBase64,
            extra_images: extraImagesBase64,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        console.log("üü¢ Sending product data with ID:", productId);
        console.log("üì¶ API URL being used:", API_BASE_URL);
        
        // Send to backend API
        const response = await fetch(`${API_BASE_URL}/products`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productData)
        });

        console.log("üì° Response status:", response.status);
        
        // Check if response is okay
        if (!response.ok) {
            const errorText = await response.text();
            console.error("‚ùå Server error response:", errorText);
            throw new Error(`Server responded with status: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log("‚úÖ Server response:", result);

        if (result.success) {
            // Show success message with ID
            showMessage(successMessage, `‚úÖ Product "${name}" saved successfully!<br><small>ID: ${productId}</small>`);
            
            console.log("‚úÖ Product saved to database");
            
            // Ask user if they want to reset form
            setTimeout(() => {
                const choice = confirm(`Product added successfully!\n\nProduct ID: ${productId}\n\nClick OK to reset form and add another product\nClick Cancel to stay on this page`);
                
                if (choice) {
                    resetForm();
                }
            }, 1000);
        } else {
            throw new Error(result.message || result.error || 'Failed to save product');
        }
        
    } catch (error) {
        console.error("‚ùå Error saving product:", error);
        showMessage(errorMessage, `‚ùå Error: ${error.message}`);
        
        // Detailed troubleshooting
        let troubleshooting = '';
        
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            troubleshooting = `
‚ö†Ô∏è CONNECTION ERROR ‚ö†Ô∏è

Cannot connect to backend server at:
${API_BASE_URL}

Please check:
1. ‚úÖ Backend server is running: node server.js
2. ‚úÖ Server is on PORT: 3000 (from your .env file)
3. ‚úÖ No firewall/antivirus blocking
4. ‚úÖ Express server CORS is configured

To fix:
1. Open terminal in backend folder
2. Run: node server.js
3. Check if it says: "Server running on http://localhost:3000"
4. Open browser and go to: http://localhost:3000/api/products
   (Should show empty object {})
            `;
        } else if (error.message.includes('CORS')) {
            troubleshooting = 'CORS error. Check Express server CORS configuration.';
        } else {
            troubleshooting = error.message;
        }
        
        alert(`Error saving product:\n\n${troubleshooting}`);
    } finally {
        // Restore button
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}

function resetForm() {
    // Clear all inputs
    document.getElementById('name').value = '';
    document.getElementById('price').value = '';
    document.getElementById('discount').value = '0';
    percentOffInput.value = '0';
    discountedPriceInput.value = '0';
    successMessage.style.display = 'none';
    errorMessage.style.display = 'none';
    
    removeMainImage({stopPropagation: () => {}});
    
    for (let i = 0; i < 4; i++) {
        const extraSlots = document.querySelectorAll('.image-slot:not(.main)');
        extraSlots[i].innerHTML = `
        <div style="font-size:24px;color:#666"></div>
        <div class="slot-label">Extra ${i + 1}</div>
        `;
        extraSlots[i].classList.remove('filled');
        allImages.extra[i] = null;
    }
    
    document.getElementById('uploadStatus').innerHTML = "";
    
    // Focus on name field
    setTimeout(() => {
        document.getElementById('name').focus();
    }, 100);
}

// Function to view products
function viewProducts() {
    window.location.href = "product-list.html";
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        addProduct();
    } else if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        resetForm();
    } else if (e.ctrlKey && e.key === 'v') {
        e.preventDefault();
        viewProducts();
    }
});

// Initialize on load
window.addEventListener('load', async () => {
    document.getElementById('name').focus();
    
    // Show current environment info
    console.log("==================================");
    console.log("üü¢ Admin Dashboard Loaded");
    console.log("üåç Hostname:", window.location.hostname);
    console.log("üîó Using API URL:", API_BASE_URL);
    console.log("üì° Backend should be on PORT: 3000");
    console.log("==================================");
    
    // Check backend status
    const isOnline = await checkBackendStatus();
    
    if (!isOnline) {
        // Try to help user troubleshoot
        console.log("‚ùå Backend server not reachable!");
        console.log("üí° Run these commands:");
        console.log("1. cd your-backend-folder");
        console.log("2. node server.js");
        
        // Show helpful message after delay
        setTimeout(() => {
            console.log("üîó Test URL: http://localhost:3000/api/products");
        }, 2000);
    }
});
</script>
</body>
</html>