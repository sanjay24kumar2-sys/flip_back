<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Product Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:Arial,sans-serif;
}

body{
    background:#ffffff;
    overflow-x:hidden;
}

.header{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    z-index:1000;
    background:#fff;
}

.header img{
    width:100%;
    display:block;
}

.header-space{
    height:110px;
}

.slider{
    display:flex;
    overflow-x:auto;
    scroll-snap-type:x mandatory;
    scrollbar-width:none;
}

.slider::-webkit-scrollbar{
    display:none;
}

.slide{
    min-width:100%;
    height:320px;
    scroll-snap-align:center;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
}

.slide img{
    width:100%;
    height:100%;
    object-fit:contain;
}

.dots{
    display:flex;
    justify-content:center;
    gap:6px;
    padding:10px 0;
    background:#fff;
}

.dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ccc;
    transition:all 0.3s;
    cursor:pointer;
}

.dot.active{
    background:#2874f0;
    transform:scale(1.2);
}

.product-detail{
    background:#fff;
    margin-top:8px;
    padding:16px;
}

.product-title{
    font-size:16px;
    font-weight:600;
    margin-bottom:10px;
    line-height:1.4;
    color:#212121;
}

.price-row{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:12px;
    flex-wrap:wrap;
}

.discount{
    color:#388e3c;
    font-weight:600;
    background:#f0f9ff;
    padding:2px 6px;
    border-radius:4px;
    font-size:13px;
}

.old-price{
    text-decoration:line-through;
    color:#878787;
    font-size:14px;
}

.new-price{
    font-size:22px;
    font-weight:700;
    color:#212121;
}

.price-info{
    display:flex;
    align-items:center;
    gap:8px;
    margin-top:4px;
}

.inclusive-tax{
    font-size:12px;
    color:#388e3c;
}

.emi{
    font-size:12px;
    color:#2874f0;
}

.rating{
    display:flex;
    align-items:center;
    gap:8px;
    margin:12px 0;
    padding-bottom:12px;
    border-bottom:1px solid #f0f0f0;
}

.rating-badge{
    background:#388e3c;
    color:#fff;
    padding:4px 8px;
    border-radius:4px;
    font-size:12px;
    font-weight:600;
}

.rating-count{
    color:#878787;
    font-size:12px;
}

.bank-offer{
    background:#f7faff;
    border:1px solid #dbe7ff;
    padding:12px;
    border-radius:6px;
    margin-bottom:12px;
    font-size:14px;
}

.bank-offer b{
    color:#212121;
}

.warranty-offer{
    background:#fff8e6;
    border:1px solid #ffdd99;
    padding:12px;
    border-radius:6px;
    margin-bottom:12px;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:10px;
}

.warranty-offer b{
    color:#212121;
}

.warranty-icon{
    background:#ff9800;
    color:white;
    width:24px;
    height:24px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    font-weight:bold;
}

/* About Product Section - Flipkart Style */
.about-product-section{
    background:#fff;
    margin-top:8px;
    padding:16px;
}

.about-product-header{
    font-size:20px;
    font-weight:600;
    color:#212121;
    margin-bottom:20px;
    padding-bottom:15px;
    border-bottom:1px solid #e0e0e0;
}

.product-specs{
    margin-bottom:25px;
}

.spec-category{
    font-size:16px;
    font-weight:600;
    color:#212121;
    margin:20px 0 12px 0;
}

.spec-category:first-child{
    margin-top:0;
}

.spec-item{
    display:flex;
    margin-bottom:10px;
    padding-bottom:10px;
    border-bottom:1px dashed #f0f0f0;
}

.spec-label{
    width:160px;
    color:#878787;
    font-size:14px;
}

.spec-value{
    flex:1;
    color:#212121;
    font-size:14px;
    font-weight:500;
}

.product-description{
    color:#212121;
    line-height:1.6;
    font-size:14px;
    margin-top:20px;
}

/* Customer Reviews Section */
.customer-reviews-section{
    background:#fff;
    margin-top:8px;
    padding:16px;
}

.customer-reviews-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:20px;
    padding-bottom:15px;
    border-bottom:1px solid #e0e0e0;
}

.customer-reviews-title{
    font-size:20px;
    font-weight:600;
    color:#212121;
}

.view-all-reviews{
    color:#2874f0;
    font-size:14px;
    text-decoration:none;
    font-weight:600;
}

.reviews-list{
    margin-top:20px;
}

.review-item{
    padding:20px 0;
    border-bottom:1px solid #f0f0f0;
}

.review-content-wrapper{
    display:flex;
    flex-direction:column;
    gap:15px;
}

.review-header{
    display:flex;
    justify-content:space-between;
    margin-bottom:8px;
}

.reviewer-name{
    font-weight:600;
    color:#212121;
    font-size:14px;
}

/* DATE REMOVED - ये हटा दिया गया */
/* .review-date{
    color:#878787;
    font-size:14px;
} */

.review-rating{
    color:#ff9f00;
    margin-bottom:8px;
    font-size:16px;
}

.review-text{
    color:#212121;
    line-height:1.6;
    font-size:14px;
    margin-bottom:10px;
}

/* CUSTOMER REVIEWS IMAGES SECTION - TEXT CHANGED FROM "Customer Images" TO "Customer Reviews" */
.customer-images-section {
    background: #fff;
    margin-top: 8px;
    padding: 16px;
    border-top: 1px solid #e0e0e0;
}

.customer-images-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.customer-images-title {
    font-size: 18px;
    font-weight: 600;
    color: #212121;
}

.view-all-images-btn {
    color: #2874f0;
    font-size: 14px;
    font-weight: 600;
    background: none;
    border: none;
    cursor: pointer;
    text-decoration: none;
}

/* Flipkart-style Image Grid - पहले 5 images */
.customer-images-grid {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    overflow-x: auto;
    scrollbar-width: none;
}

.customer-images-grid::-webkit-scrollbar {
    display: none;
}

.customer-image-item {
    min-width: 100px;
    height: 100px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e0e0e0;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.customer-image-item:hover {
    transform: scale(1.03);
    border-color: #2874f0;
    box-shadow: 0 2px 8px rgba(40, 116, 240, 0.2);
}

.customer-image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* + More Images Button - EXACTLY LIKE IMAGE */
.more-images-container {
    min-width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    border: 2px dashed #ccc;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
    text-decoration: none;
}

.more-images-container:hover {
    background: #f0f7ff;
    border-color: #2874f0;
}

.more-images-content {
    text-align: center;
    padding: 10px;
}

.more-count {
    font-size: 24px;
    font-weight: bold;
    color: #2874f0;
    margin-bottom: 5px;
}

.more-text {
    font-size: 12px;
    color: #666;
    font-weight: 500;
}

.no-images-message{
    color:#878787;
    font-style:italic;
    padding:20px 0;
    font-size:14px;
    text-align:center;
}

.loading-reviews{
    text-align:center;
    padding:30px;
    color:#878787;
    font-style:italic;
}

/* Ratings and Reviews Section - EXACTLY LIKE IMAGE */
.ratings-section{
    background:#fff;
    margin-top:8px;
    padding:16px;
    margin-bottom:120px;
}

.ratings-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:20px;
    padding-bottom:15px;
    border-bottom:1px solid #e0e0e0;
}

.ratings-title{
    font-size:20px;
    font-weight:600;
    color:#212121;
}

.action-buttons{
    display:flex;
    gap:12px;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:#fff;
    padding:16px 16px 20px;
    border-top:1px solid #f0f0f0;
    z-index:1000;
}

.buy-btn{
    flex:1;
    background:#fb641b;
    color:#fff;
    border:none;
    padding:14px;
    border-radius:6px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    width:100%;
    transition:background 0.3s;
}

.buy-btn:hover{
    background:#e55a17;
}

.cart-btn{
    flex:1;
    background:#ff9f00;
    color:#fff;
    border:none;
    padding:14px;
    border-radius:6px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    transition:background 0.3s;
    /* यहाँ display: none कर दो */
    display: none !important;
}

.cart-btn:hover{
    background:#e58e00;
}

.ratings-overview{
    display:flex;
    align-items:center;
    gap:20px;
    margin-bottom:30px;
}

.overall-rating{
    text-align:center;
    padding:20px;
    background-color:white;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.05);
    min-width:180px;
}

.rating-value{
    font-size:36px;
    font-weight:700;
    color:#212121;
}

.rating-stars{
    color:#ff9f00;
    margin:8px 0;
    font-size:18px;
}

.rating-text{
    font-size:14px;
    color:#212121;
    margin-bottom:5px;
    font-weight:600;
}

.total-ratings{
    color:#878787;
    font-size:14px;
}

.verified-buyer{
    color:#388e3c;
    font-size:14px;
    margin-top:5px;
    display:flex;
    align-items:center;
    justify-content:center;
}

.action-buttons{
    display:flex;
    gap:12px;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:#fff;
    padding:16px 16px 20px;
    border-top:1px solid #f0f0f0;
    z-index:1000;
}

.buy-btn{
    flex:1;
    background:#fb641b;
    color:#fff;
    border:none;
    padding:14px;
    border-radius:6px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    width:100%;
    transition:background 0.3s;
}

.buy-btn:hover{
    background:#e55a17;
}

.cart-btn{
    flex:1;
    background:#ff9f00;
    color:#fff;
    border:none;
    padding:14px;
    border-radius:6px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    transition:background 0.3s;
}

.cart-btn:hover{
    background:#e58e00;
}

.loading{
    text-align:center;
    padding:40px;
    font-size:16px;
    color:#878787;
}

.error{
    text-align:center;
    padding:40px;
    font-size:16px;
    color:#ff6161;
}

.back-btn{
    display:inline-block;
    background:#2874f0;
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:4px;
    cursor:pointer;
    margin-top:10px;
    text-decoration:none;
}

.loader{
    display:inline-block;
    width:20px;
    height:20px;
    border:3px solid #f3f3f3;
    border-top:3px solid #2874f0;
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-right:10px;
}

@keyframes spin{
    0%{transform:rotate(0deg);}
    100%{transform:rotate(360deg);}
}

.skeleton-loader{
    background:#fff;
    border-radius:14px;
    overflow:hidden;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.skeleton-img{
    height:140px;
    background:#f0f0f0;
    position:relative;
    overflow:hidden;
}

.skeleton-img::after{
    content:"";
    position:absolute;
    top:0;
    left:-100%;
    width:100%;
    height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.5),transparent);
    animation:skeleton-loading 1.5s infinite;
}

.skeleton-content{
    padding:12px;
}

.skeleton-title{
    height:18px;
    width:80%;
    background:#f0f0f0;
    border-radius:4px;
    margin-bottom:10px;
    position:relative;
    overflow:hidden;
}

.skeleton-title::after{
    content:"";
    position:absolute;
    top:0;
    left:-100%;
    width:100%;
    height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.5),transparent);
    animation:skeleton-loading 1.5s infinite 0.2s;
}

.skeleton-price{
    height:22px;
    width:40%;
    background:#f0f0f0;
    border-radius:4px;
    position:relative;
    overflow:hidden;
}

.skeleton-price::after{
    content:"";
    position:absolute;
    top:0;
    left:-100%;
    width:100%;
    height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.5),transparent);
    animation:skeleton-loading 1.5s infinite 0.4s;
}

@keyframes skeleton-loading{
    0%{left:-100%;}
    100%{left:100%;}
}

/* Image Modal Styles */
.image-modal{
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.95);
    z-index:2000;
    align-items:center;
    justify-content:center;
    padding:20px;
}

.modal-content{
    max-width:100%;
    max-height:100%;
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
}

.modal-image{
    max-width:90%;
    max-height:80vh;
    object-fit:contain;
    border-radius:8px;
    box-shadow:0 5px 20px rgba(0,0,0,0.5);
}

.modal-nav{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    width:100%;
    display:flex;
    justify-content:space-between;
    padding:0 20px;
    pointer-events:none;
}

.nav-btn{
    background:rgba(255,255,255,0.2);
    color:white;
    border:none;
    width:50px;
    height:50px;
    border-radius:50%;
    font-size:24px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:all;
    transition:background 0.3s;
}

.nav-btn:hover{
    background:rgba(255,255,255,0.3);
}

.close-modal{
    position:absolute;
    top:20px;
    right:20px;
    background:rgba(255,255,255,0.2);
    color:white;
    border:none;
    width:50px;
    height:50px;
    border-radius:50%;
    font-size:30px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:background 0.3s;
    z-index:2001;
}

.close-modal:hover{
    background:rgba(255,255,255,0.3);
}

.image-counter{
    position:absolute;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.7);
    color:white;
    padding:8px 16px;
    border-radius:20px;
    font-size:14px;
}

@media (max-width: 768px) {
    .ratings-overview {
        flex-direction: column;
    }
    
    .overall-rating {
        width: 100%;
    }
    
    .spec-item {
        flex-direction: column;
    }
    
    .spec-label {
        width: 100%;
        margin-bottom: 4px;
    }
    
    .action-buttons {
        padding: 12px 16px;
    }
    
    .buy-btn, .cart-btn {
        padding: 12px;
        font-size: 15px;
    }
    
    .customer-image-item {
        height: 80px;
        min-width: 80px;
    }
    
    .more-images-container {
        height: 80px;
        min-width: 80px;
    }
    
    .nav-btn {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    .close-modal {
        width: 40px;
        height: 40px;
        font-size: 24px;
    }
}

@media (max-width: 480px) {
    .customer-images-grid {
        gap: 8px;
    }
}
</style>
</head>

<body>

<div class="header">
    <img src="assets/images/topup.png" alt="Top Banner">
    <img src="assets/images/uskeniche.png" alt="Bottom Banner">
</div>
<div class="header-space"></div>

<div id="productContainer">
    <div class="loading">
        <span class="loader"></span> Loading product details...
    </div>
</div>

<div id="imageModal" class="image-modal">
    <div class="modal-content">
        <img id="modalImage" class="modal-image" src="" alt="Customer Review">
        <div class="modal-nav">
            <button class="nav-btn" id="prevImageBtn">‹</button>
            <button class="nav-btn" id="nextImageBtn">›</button>
        </div>
        <button class="close-modal" id="closeModal">×</button>
        <div class="image-counter" id="imageCounter">1 / 1</div>
    </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get('id');

const API_URL = "/api/products";
const REVIEWS_API_URL = `/api/reviews/${productId}`;
const ABOUT_PRODUCT_API_URL = `/api/about-product/${productId}`;

let autoScrollInterval;
let currentSlideIndex = 0;
let totalSlides = 0;
let allReviews = [];
let currentModalImages = [];
let currentModalIndex = 0;
let allImagesFromAllReviews = [];

function formatPrice(price){
    if(price === undefined || price === null || price === '' || isNaN(price)) {
        return "₹0";
    }
    
    const num = parseFloat(price);
    if(isNaN(num)) return "₹0";
    
    if(num >= 10000000){
        return '₹' + (num / 10000000).toFixed(1) + ' Cr';
    } else if(num >= 100000){
        return '₹' + (num / 100000).toFixed(1) + ' L';
    } else if(num >= 1000){
        return '₹' + num.toLocaleString('en-IN');
    } else {
        return '₹' + num.toFixed(0);
    }
}

function calculateDiscountPercent(originalPrice, discountedPrice){
    if(!originalPrice || !discountedPrice || originalPrice <= 0 || discountedPrice <= 0) return 0;
    
    const original = parseFloat(originalPrice);
    const discounted = parseFloat(discountedPrice);
    
    if(isNaN(original) || isNaN(discounted) || original <= discounted) return 0;
    
    const discount = ((original - discounted) / original) * 100;
    return Math.round(discount);
}

function initAutoScroll(sliderEl,dotsEl){
    if(autoScrollInterval){
        clearInterval(autoScrollInterval);
    }
    autoScrollInterval=setInterval(()=>{
        currentSlideIndex++;
        if(currentSlideIndex>=totalSlides){
            currentSlideIndex=0;
        }
        scrollToSlide(currentSlideIndex,sliderEl,dotsEl);
    },3000);
    sliderEl.addEventListener('mouseenter',()=>{
        if(autoScrollInterval){
            clearInterval(autoScrollInterval);
        }
    });
    sliderEl.addEventListener('mouseleave',()=>{
        initAutoScroll(sliderEl,dotsEl);
    });
}

function scrollToSlide(index,sliderEl,dotsEl){
    currentSlideIndex=index;
    const slideWidth=sliderEl.offsetWidth;
    sliderEl.scrollTo({
        left:index*slideWidth,
        behavior:'smooth'
    });
    if(dotsEl&&dotsEl.length>0){
        dotsEl.forEach(dot=>dot.classList.remove('active'));
        if(dotsEl[index]) dotsEl[index].classList.add('active');
    }
}

function navigateToAddressPage(productName,productPrice,productId){
    const encodedName=encodeURIComponent(productName);
    const encodedPrice=encodeURIComponent(productPrice);
    const encodedId=encodeURIComponent(productId);
    window.location.href=`address.html?name=${encodedName}&price=${encodedPrice}&id=${encodedId}`;
}

function addToCart(productId,productName,productPrice){
    try{
        let cart=JSON.parse(localStorage.getItem('cart'))||[];
        const existingItemIndex=cart.findIndex(item=>item.id===productId);
        if(existingItemIndex>-1){
            cart[existingItemIndex].quantity+=1;
        }else{
            cart.push({
                id:productId,
                name:productName,
                price:productPrice,
                quantity:1,
                timestamp:new Date().getTime()
            });
        }
        localStorage.setItem('cart',JSON.stringify(cart));
        alert(`${productName} added to cart successfully!`);
        updateCartCount();
    }catch(error){
        alert("Failed to add item to cart. Please try again.");
    }
}

function updateCartCount(){
    const cart=JSON.parse(localStorage.getItem('cart'))||[];
    const totalItems=cart.reduce((total,item)=>total+item.quantity,0);
    const cartCountElement=document.getElementById('cartCount');
    if(cartCountElement){
        cartCountElement.textContent=totalItems;
    }
}

function showSkeleton(){
    const container=document.getElementById('productContainer');
    container.innerHTML=`
        <div class="skeleton-loader">
            <div class="skeleton-img"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-price"></div>
            </div>
        </div>
        <div style="background:#fff;margin-top:8px;padding:16px;">
            <div class="skeleton-title" style="width:60%;height:16px;margin-bottom:8px;"></div>
            <div class="skeleton-title" style="width:100%;height:14px;margin-bottom:6px;"></div>
            <div class="skeleton-title" style="width:90%;height:14px;margin-bottom:6px;"></div>
            <div class="skeleton-title" style="width:80%;height:14px;margin-bottom:6px;"></div>
        </div>
        <div style="background:#fff;margin-top:8px;padding:16px;">
            <div class="skeleton-title" style="width:40%;height:20px;margin-bottom:12px;"></div>
            <div class="skeleton-title" style="width:100%;height:14px;margin-bottom:8px;"></div>
            <div class="skeleton-title" style="width:90%;height:14px;margin-bottom:8px;"></div>
        </div>
        <div style="position:fixed;bottom:0;left:0;right:0;background:#fff;padding:16px;border-top:1px solid #f0f0f0;">
            <div class="skeleton-title" style="width:100%;height:50px;border-radius:6px;"></div>
        </div>
    `;
}

function getStarRating(rating){
    let stars='';
    const fullStars = Math.floor(rating);
    
    for(let i=1;i<=5;i++){
        if(i<=fullStars){
            stars+='★';
        }else{
            stars+='☆';
        }
    }
    return stars;
}

// API se reviews fetch karo
async function getReviewsFromAPI(){
    try {
        const response = await fetch(REVIEWS_API_URL);
        if(response.ok){
            const reviewsData = await response.json();
            
            if(reviewsData.success && Array.isArray(reviewsData.data)){
                console.log("Reviews API data:", reviewsData.data);
                
                // Calculate average rating
                const validReviews = reviewsData.data.filter(review => review.rating && review.rating > 0);
                const totalRating = validReviews.reduce((sum, review) => sum + (review.rating || 0), 0);
                const averageRating = validReviews.length > 0 ? totalRating / validReviews.length : 0;
                
                // Reviews ko format karo
                const formattedReviews = reviewsData.data.map(review => {
                    // Format date properly
                    let reviewDate = "";
                    if(review.created_at){
                        try {
                            reviewDate = new Date(review.created_at).toLocaleDateString('en-IN');
                        } catch(e) {
                            reviewDate = review.date || "";
                        }
                    }
                    
                    // Handle images from API
                    let reviewImages = [];
                    
                    // Method 1: images field directly
                    if(review.images && Array.isArray(review.images)){
                        reviewImages = review.images.filter(img => img && img.trim() !== '');
                    } 
                    // Method 2: files field
                    else if(review.files && Array.isArray(review.files)){
                        reviewImages = review.files
                            .map(file => file.url || file.filename || file)
                            .filter(img => img && img.trim() !== '');
                    }
                    
                    // Method 3: Check for common image fields
                    if(reviewImages.length === 0){
                        const possibleImageFields = ['image', 'photo', 'img', 'picture', 'attachment'];
                        for(const field of possibleImageFields){
                            if(review[field] && review[field].trim() !== ''){
                                reviewImages.push(review[field]);
                                break;
                            }
                        }
                    }
                    
                    return {
                        id: review.id || Math.random().toString(36).substr(2, 9),
                        name: review.customer_name || "Customer",
                        rating: review.rating || 0,
                        date: reviewDate, // DATE रखा गया है लेकिन HTML में नहीं दिखेगा
                        text: review.review_text || review.comment || "No comment provided",
                        images: reviewImages
                    };
                });
                
                return {
                    averageRating: averageRating,
                    totalReviews: reviewsData.data.length,
                    reviews: formattedReviews
                };
            }
        }
    } catch(error) {
        console.log("Reviews API error:", error);
    }
    
    // Agar API fail ho to empty data
    return {
        averageRating: 0,
        totalReviews: 0,
        reviews: []
    };
}

// API se about product fetch karo
async function getAboutProductFromAPI(){
    try {
        const response = await fetch(ABOUT_PRODUCT_API_URL);
        if(response.ok){
            const aboutData = await response.json();
            console.log("About Product API data:", aboutData);
            
            if(aboutData.success && Array.isArray(aboutData.data) && aboutData.data.length > 0){
                return aboutData.data[0];
            }
        }
    } catch(error) {
        console.log("About Product API error:", error);
    }
    
    return null;
}

function generateAboutProductHTML(product, aboutData){
    console.log("Generating about product with:", {product, aboutData});
    
    let descriptionHTML = '';
    
    if(aboutData && aboutData.content){
        descriptionHTML = `
            <div class="product-description">
                ${aboutData.content}
            </div>
        `;
    }
    else if(product.description){
        descriptionHTML = `
            <div class="product-description">
                ${product.description}
            </div>
        `;
    } else {
        descriptionHTML = `
            <div class="product-description">
                This is a high-quality product with excellent features and performance. 
                It offers great value for money and comes with manufacturer warranty.
            </div>
        `;
    }
    
    const specs = [];
    
    if(product.category){
        specs.push({
            label: "Category",
            value: product.category
        });
    }
    
    if(product.brand){
        specs.push({
            label: "Brand",
            value: product.brand
        });
    }
    
    if(product.model){
        specs.push({
            label: "Model",
            value: product.model
        });
    }
    
    if(product.color){
        specs.push({
            label: "Color",
            value: product.color
        });
    }
    
    const warrantyValue = product.warranty || "1 year manufacturer warranty";
    specs.push({
        label: "Warranty",
        value: warrantyValue
    });
    
    let specsHTML = '';
    if(specs.length > 0){
        specsHTML = `
            <div class="product-specs">
                <div class="spec-category">Product Details</div>
                ${specs.map(spec => `
                    <div class="spec-item">
                        <div class="spec-label">${spec.label}</div>
                        <div class="spec-value">${spec.value}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    return `
        <section class="about-product-section">
            <div class="about-product-header">About this item</div>
            ${specsHTML}
            ${descriptionHTML}
        </section>
    `;
}

// Generate customer reviews HTML with text reviews
function generateCustomerReviewsHTML(reviewsData){
    allReviews = reviewsData.reviews || [];
    const initialReviews = allReviews.slice(0, 3);
    
    let reviewsListHTML = '';
    
    if(initialReviews && initialReviews.length > 0){
        initialReviews.forEach((review, reviewIndex) => {
            reviewsListHTML += `
                <div class="review-item">
                    <div class="review-content-wrapper">
                        <div class="review-header">
                            <div class="reviewer-name">${review.name}</div>
                            <!-- DATE REMOVED - ये हटा दिया गया -->
                        </div>
                        <div class="review-rating">
                            ${getStarRating(review.rating)}
                        </div>
                        <div class="review-text">${review.text}</div>
                    </div>
                </div>
            `;
        });
    } else {
        reviewsListHTML = `
            <div class="loading-reviews">
                No reviews available yet. Be the first to review this product!
            </div>
        `;
    }
    
    // सभी reviews से सभी images collect करो
    allImagesFromAllReviews = [];
    let totalImagesCount = 0;
    
    allReviews.forEach((review, reviewIndex) => {
        if(review.images && review.images.length > 0){
            review.images.forEach((imgSrc, imgIndex) => {
                allImagesFromAllReviews.push({
                    src: imgSrc,
                    reviewIndex: reviewIndex,
                    imgIndex: imgIndex,
                    reviewerName: review.name,
                    reviewId: review.id
                });
                totalImagesCount++;
            });
        }
    });
    
    const viewAllButton = allReviews.length > 3 ? `
        <div style="text-align:center;margin-top:20px;">
            <button id="viewAllReviewsBtn" style="background:#2874f0;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;">
                View All ${allReviews.length} Reviews
            </button>
        </div>
    ` : '';
    
    return `
        <section class="customer-reviews-section">
            <div class="customer-reviews-header">
                <div class="customer-reviews-title">Customer Reviews</div>
                ${allReviews.length > 3 ? `<a href="#" class="view-all-reviews" id="viewAllReviewsLink">View All</a>` : ''}
            </div>
            
            <div class="reviews-list">
                ${reviewsListHTML}
            </div>
            
            ${viewAllButton}
        </section>
    `;
}

// CUSTOMER REVIEWS SECTION (IMAGES) - TEXT CHANGED FROM "Customer Images" TO "Customer Reviews"
function generateCustomerImagesHTML() {
    if (allImagesFromAllReviews.length === 0) {
        return `
            <section class="customer-images-section">
                <div class="customer-images-header">
                    <div class="customer-images-title">Customer Reviews (0)</div>
                </div>
                <div class="no-images-message">No customer reviews uploaded yet</div>
            </section>
        `;
    }
    
    // पहले 5 images दिखाओ
    const firstFiveImages = allImagesFromAllReviews.slice(0, 5);
    const remainingImagesCount = allImagesFromAllReviews.length - 5;
    
    let imagesGridHTML = '';
    
    // पहले 5 images
    firstFiveImages.forEach((imgData, index) => {
        imagesGridHTML += `
            <div class="customer-image-item" 
                 data-index="${index}"
                 onclick="openImageInModal(${index})">
                <img src="${imgData.src}" alt="Customer review" 
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/200x200?text=Customer+Review'">
            </div>
        `;
    });
    
    // अगर 5 से ज्यादा images हैं तो + button दिखाओ जो all.html पर navigate करेगा
    if (remainingImagesCount > 0) {
        imagesGridHTML += `
            <a href="all.html?productId=${productId}" class="more-images-container">
                <div class="more-images-content">
                    <div class="more-count">+${remainingImagesCount}</div>
                    <div class="more-text">More</div>
                </div>
            </a>
        `;
    }
    
    return `
        <section class="customer-images-section">
            <div class="customer-images-header">
                <div class="customer-images-title">Customer Reviews (${allImagesFromAllReviews.length})</div>
                ${allImagesFromAllReviews.length > 5 ? 
                    `<a href="all.html?productId=${productId}" class="view-all-images-btn">View All</a>` : 
                    ''
                }
            </div>
            <div class="customer-images-grid">
                ${imagesGridHTML}
            </div>
        </section>
    `;
}

// RATINGS SECTION - EXACTLY LIKE IMAGE
function generateRatingsHTML(reviewsData){
    // Hardcoded values like the image
    const averageRating = "4.0";
    const totalReviews = "12,487";
    
    return `
        <section class="ratings-section">
            <div class="ratings-header">
                <div class="ratings-title">Ratings & Reviews</div>
            </div>
            
            <div class="ratings-overview">
                <div class="overall-rating">
                    <div class="rating-value">${averageRating}</div>
                    <div class="rating-text">Good</div>
                    <div class="rating-stars">
                        ★★★★☆
                    </div>
                    <div class="total-ratings">based on ${totalReviews} ratings by Verified Buyers</div>
                </div>
            </div>
        </section>
    `;
}

// Show all reviews - सिर्फ text
function showAllReviews(){
    const reviewsList = document.querySelector('.reviews-list');
    if(!reviewsList) return;
    
    let reviewsListHTML = '';
    
    allReviews.forEach((review, reviewIndex) => {
        reviewsListHTML += `
            <div class="review-item">
                <div class="review-content-wrapper">
                    <div class="review-header">
                        <div class="reviewer-name">${review.name}</div>
                        <!-- DATE REMOVED - ये हटा दिया गया -->
                    </div>
                    <div class="review-rating">
                        ${getStarRating(review.rating)}
                    </div>
                    <div class="review-text">${review.text}</div>
                </div>
            </div>
        `;
    });
    
    reviewsList.innerHTML = reviewsListHTML;
    
    const viewAllBtn = document.getElementById('viewAllReviewsBtn');
    if(viewAllBtn) viewAllBtn.style.display = 'none';
    
    const viewAllLink = document.getElementById('viewAllReviewsLink');
    if(viewAllLink) viewAllLink.textContent = `View All ${allReviews.length} Reviews`;
}

// Open single image in modal
function openImageInModal(index){
    if(!allImagesFromAllReviews || allImagesFromAllReviews.length === 0) return;
    
    currentModalImages = allImagesFromAllReviews.map(img => img.src);
    currentModalIndex = index;
    
    updateModalImage();
    document.getElementById('imageModal').style.display = 'flex';
    
    // Update image counter with reviewer name
    const currentImg = allImagesFromAllReviews[index];
    const imageCounter = document.getElementById('imageCounter');
    if(currentImg){
        imageCounter.textContent = `${index + 1} / ${allImagesFromAllReviews.length} - ${currentImg.reviewerName}`;
    } else {
        imageCounter.textContent = `${index + 1} / ${allImagesFromAllReviews.length}`;
    }
    
    // Keyboard navigation enable
    document.addEventListener('keydown', handleModalKeyboard);
}

function updateModalImage(){
    if(currentModalImages.length === 0) return;
    
    const modalImage = document.getElementById('modalImage');
    const imageCounter = document.getElementById('imageCounter');
    
    // Ensure index is within bounds
    if(currentModalIndex < 0) currentModalIndex = currentModalImages.length - 1;
    if(currentModalIndex >= currentModalImages.length) currentModalIndex = 0;
    
    modalImage.src = currentModalImages[currentModalIndex];
    
    // Update image counter with reviewer name
    const currentImg = allImagesFromAllReviews[currentModalIndex];
    if(currentImg){
        imageCounter.textContent = `${currentModalIndex + 1} / ${currentModalImages.length} - ${currentImg.reviewerName}`;
    } else {
        imageCounter.textContent = `${currentModalIndex + 1} / ${currentModalImages.length}`;
    }
    
    // Update button visibility
    const prevBtn = document.getElementById('prevImageBtn');
    const nextBtn = document.getElementById('nextImageBtn');
    
    if(currentModalImages.length <= 1){
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    } else {
        prevBtn.style.display = 'flex';
        nextBtn.style.display = 'flex';
    }
}

function handleModalKeyboard(event){
    if(event.key === 'Escape'){
        closeImageModal();
    } else if(event.key === 'ArrowLeft'){
        navigateModalImage(-1);
    } else if(event.key === 'ArrowRight'){
        navigateModalImage(1);
    }
}

function navigateModalImage(direction){
    currentModalIndex += direction;
    if(currentModalIndex < 0) currentModalIndex = currentModalImages.length - 1;
    if(currentModalIndex >= currentModalImages.length) currentModalIndex = 0;
    updateModalImage();
}

function closeImageModal(){
    document.getElementById('imageModal').style.display = 'none';
    document.removeEventListener('keydown', handleModalKeyboard);
}

// Initialize Image Modal
function initImageModal(){
    const modal = document.getElementById('imageModal');
    const closeBtn = document.getElementById('closeModal');
    const prevBtn = document.getElementById('prevImageBtn');
    const nextBtn = document.getElementById('nextImageBtn');
    
    closeBtn.addEventListener('click', closeImageModal);
    
    prevBtn.addEventListener('click', () => navigateModalImage(-1));
    nextBtn.addEventListener('click', () => navigateModalImage(1));
    
    modal.addEventListener('click', (e) => {
        if(e.target === modal){
            closeImageModal();
        }
    });
}

async function loadProductDetails(){
    const container = document.getElementById('productContainer');
    
    if(!productId){
        container.innerHTML = `
            <div class="error">
                No product ID provided.
                <br><br>
                <a href="index.html" class="back-btn">Back to Home</a>
            </div>
        `;
        return;
    }
    
    showSkeleton();
    
    try {
        const response = await fetch(API_URL);
        if(!response.ok){
            throw new Error(`API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        let product = null;
        
        if(data && data.success && Array.isArray(data.data)){
            product = data.data.find(p => p.id === productId || p._id === productId);
        }
        else if(Array.isArray(data)){
            product = data.find(p => p.id === productId || p._id === productId);
        }
        else if(data && typeof data === 'object' && !Array.isArray(data)){
            product = data[productId];
            
            if(!product){
                for(let key in data){
                    if(data[key] && (data[key].id === productId || data[key]._id === productId)){
                        product = data[key];
                        break;
                    }
                }
            }
        }
        
        if(!product){
            console.log("Product not found. Available data:", data);
            container.innerHTML = `
                <div class="error">
                    Product not found in the database.
                    <br><br>
                    <a href="index.html" class="back-btn">Back to Home</a>
                </div>
            `;
            return;
        }
        
        console.log("Found product:", product);
        
        // Reviews data fetch करो
        const [reviewsData, aboutProductData] = await Promise.all([
            getReviewsFromAPI(),
            getAboutProductFromAPI()
        ]);
        
        console.log("Reviews data:", reviewsData);
        console.log("About product data:", aboutProductData);
        
        const name = product.name || "Product Name";
        const originalPrice = product.price || 0;
        const discountAmount = product.discount_amount || 0;
        const discountPercent = product.discount_percent || 0;
        const discountedPrice = product.discounted_price || 0;
        
        let sellingPrice = discountedPrice;
        if(!sellingPrice && originalPrice && discountAmount){
            sellingPrice = originalPrice - discountAmount;
        } else if(!sellingPrice && originalPrice && discountPercent){
            sellingPrice = originalPrice * (1 - discountPercent / 100);
        } else if(!sellingPrice){
            sellingPrice = originalPrice;
        }
        
        if(isNaN(sellingPrice)) sellingPrice = 0;
        
        let finalDiscountPercent = discountPercent;
        if(!finalDiscountPercent && originalPrice > 0 && sellingPrice > 0){
            finalDiscountPercent = calculateDiscountPercent(originalPrice, sellingPrice);
        }
        
        const formattedOriginalPrice = formatPrice(originalPrice);
        const formattedSellingPrice = formatPrice(sellingPrice);
        
        let mainImage = product.main_image || product.image || '';
        let extraImages = product.extra_images || [];
        
        if(!mainImage && product.images && Array.isArray(product.images) && product.images.length > 0){
            mainImage = product.images[0];
            extraImages = product.images.slice(1);
        }
        
        const allImages = [mainImage, ...extraImages].filter(img => img && img.trim() !== '');
        
        if(allImages.length === 0){
            allImages.push('https://via.placeholder.com/400x400?text=Product+Image');
        }
        
        totalSlides = allImages.length;
        let sliderHTML = '';
        let dotsHTML = '';
        
        allImages.forEach((img, index) => {
            sliderHTML += `
                <div class="slide">
                    <img src="${img}" alt="${name} - Image ${index+1}" 
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/400x400?text=Product+Image'">
                </div>
            `;
            dotsHTML += `<span class="dot ${index===0?'active':''}" data-index="${index}"></span>`;
        });
        
        const aboutProductHTML = generateAboutProductHTML(product, aboutProductData);
        const customerReviewsHTML = generateCustomerReviewsHTML(reviewsData);
        const customerImagesHTML = generateCustomerImagesHTML();
        const ratingsHTML = generateRatingsHTML(reviewsData);
        
        const productHTML = `
            <div class="slider-wrapper">
                <div class="slider" id="slider">
                    ${sliderHTML}
                </div>
                ${allImages.length > 1 ? `
                    <div class="dots" id="dots">
                        ${dotsHTML}
                    </div>
                ` : ''}
            </div>

            <section class="product-detail">
                <h2 class="product-title">${name}</h2>
                <div class="price-row">
                    ${finalDiscountPercent > 0 ? `<span class="discount">${finalDiscountPercent}% off</span>` : ''}
                    ${originalPrice > sellingPrice ? `<span class="old-price">${formattedOriginalPrice}</span>` : ''}
                    <span class="new-price">${formattedSellingPrice}</span>
                </div>
                <div class="price-info">
                    <span class="inclusive-tax">Inclusive of all taxes</span>
                    <span class="emi">EMI starts at ₹${Math.round(sellingPrice/6)}/month</span>
                </div>
                <div class="rating">
                    <span class="rating-badge">${reviewsData.averageRating > 0 ? reviewsData.averageRating.toFixed(1) : '4.0'} ★</span>
                    <span class="rating-count">${reviewsData.totalReviews > 0 ? reviewsData.totalReviews.toLocaleString() : '12,487'} Ratings & Reviews</span>
                </div>
                <div class="bank-offer">
                    <b>Special Bank Offer</b><br>
                    Get 5% cashback up to ₹500 on Flipkart Axis Bank Credit Card
                </div>
                <div class="warranty-offer">
                    <div class="warranty-icon">✓</div>
                    <div><b>Warranty:</b> 1 year manufacturer warranty from the date of purchase</div>
                </div>
            </section>
            
            ${aboutProductHTML}
            ${customerReviewsHTML}
            ${customerImagesHTML}
            ${ratingsHTML}
            
            <div class="action-buttons">
                <button class="buy-btn" id="buyNowBtn">Buy Now</button>
                <button class="cart-btn" id="addToCartBtn">Add to Cart</button>
            </div>
        `;
        
        container.innerHTML = productHTML;
        
        if(allImages.length > 1){
            const sliderEl = document.getElementById('slider');
            const dotsEl = document.querySelectorAll('.dot');
            initAutoScroll(sliderEl, dotsEl);
            
            dotsEl.forEach(dot => {
                dot.addEventListener('click', () => {
                    const index = parseInt(dot.getAttribute('data-index'));
                    scrollToSlide(index, sliderEl, dotsEl);
                    if(autoScrollInterval){
                        clearInterval(autoScrollInterval);
                        initAutoScroll(sliderEl, dotsEl);
                    }
                });
            });
            
            sliderEl.addEventListener('scroll', () => {
                const index = Math.round(sliderEl.scrollLeft / sliderEl.offsetWidth);
                if(currentSlideIndex !== index){
                    currentSlideIndex = index;
                    dotsEl.forEach(dot => dot.classList.remove('active'));
                    if(dotsEl[index]) dotsEl[index].classList.add('active');
                }
            });
        }
        
        document.getElementById('buyNowBtn')?.addEventListener('click', () => {
            navigateToAddressPage(name, sellingPrice, productId);
        });
        
        document.getElementById('addToCartBtn')?.addEventListener('click', () => {
            addToCart(productId, name, sellingPrice);
        });
        
        document.getElementById('viewAllReviewsBtn')?.addEventListener('click', showAllReviews);
        document.getElementById('viewAllReviewsLink')?.addEventListener('click', (e) => {
            e.preventDefault();
            showAllReviews();
        });
        
        initImageModal();
        updateCartCount();
        
    } catch(error) {
        console.error("Error loading product:", error);
        container.innerHTML = `
            <div class="error">
                <h3>⚠️ API Connection Failed</h3>
                <p>Failed to load product details from server.</p>
                <p><strong>Error:</strong> ${error.message}</p>
                <br>
                <p>Please check:</p>
                <ul style="text-align: left; display: inline-block;">
                    <li>Your internet connection</li>
                    <li>API server status</li>
                    <li>Try refreshing the page</li>
                </ul>
                <br><br>
                <button onclick="location.reload()" class="back-btn"> Retry</button>
                <a href="index.html" class="back-btn" style="margin-left:10px;"> Back to Home</a>
            </div>
        `;
    }
}

// Make functions globally available for onclick events
window.openImageInModal = openImageInModal;
window.navigateModalImage = navigateModalImage;
window.closeImageModal = closeImageModal;
window.showAllReviews = showAllReviews;

window.addEventListener('DOMContentLoaded', () => {
    loadProductDetails();
});

window.addEventListener('beforeunload', () => {
    if(autoScrollInterval){
        clearInterval(autoScrollInterval);
    }
});
</script>
</body>
</html>